<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tidsregistrering</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root { --muted:#6c757d; }
  body { font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  th.sortable { cursor: pointer; }
  th.sortable .sort-ind { opacity: .6; font-size: .9em; margin-left: .25rem; }
  .help-list dt { font-weight: 700; margin-top:.75rem; }
  .small-muted { color: var(--muted); font-size: .875rem; }
  footer .small-muted { font-size: .75rem; }
</style>
</head>
<body class="bg-light">
<div class="container-fluid py-4" style="max-width: 90%; margin: auto;">
  <h1 class="text-center mb-4">Tidsregistrering</h1>

  <!-- Indstillinger + Hjælp knapper -->
  <div class="mb-3 d-flex justify-content-end gap-2">
    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#settingsPanel" aria-expanded="false" title="Indstillinger">
      Indstillinger
    </button>
    <button class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#helpPanel" aria-expanded="false" title="Hjælp">
      ?
    </button>
  </div>

  <!-- Indstillinger -->
  <div id="settingsPanel" class="collapse">
    <div class="card p-3 shadow-sm mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4">
          <label for="resumeThreshold" class="form-label">Fortsæt hvis arkiveret inden (minutter)</label>
          <input type="number" id="resumeThreshold" class="form-control" min="0" step="1" placeholder="10">
          <div class="small-muted mt-1">“Start her” fortsætter fra en tidligere registrering, hvis postens dato+tid er nyere end grænsen. Ellers startes fra 0.</div>
        </div>
        <div class="col-lg-8">
          <div class="border rounded p-2 bg-light">
            <div class="fw-semibold mb-2">Hurtig datahåndtering</div>
            <div class="d-flex flex-wrap gap-2">
              <button id="btnGenSample" class="btn btn-outline-primary">Generér 102000 eksempelrækker</button>
              <button id="btnDeleteAll" class="btn btn-outline-danger">Slet alle rækker</button>
            </div>
            <div class="small-muted mt-2">
              • <strong>Generér</strong> opretter op til 102000 demo-poster (datoer, felter og tid).<br>
              • <strong>Slet alle</strong> tømmer tabellen (IndexedDB). Begge kræver bekræftelse.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hjælp -->
  <div id="helpPanel" class="collapse">
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="mb-3">Hvordan virker siden?</h5>
      <dl class="help-list">
        <dt>Formål</dt>
        <dd>Hurtig tidsregistrering i browseren. Data gemmes i <em>IndexedDB</em> på denne enhed. Du kan starte/stoppe timer, kopiere tidligere rækker og eksportere til Excel.</dd>

        <dt>Felter</dt>
        <dd>
          <ul class="mb-2">
            <li><strong>Dato + tid</strong>: dansk format (24t med sekunder).</li>
            <li><strong>Brugernavn</strong>: e-mail (valideres).</li>
            <li><strong>Projektnummer</strong> (7 cifre starter med 19–25), <strong>Aktivitetskode</strong> (4 cifre, runde tal), <strong>Sag #</strong> (max 10), <strong>Beskrivelse</strong>.</li>
            <li><strong>Tid</strong>: HH:MM:SS, DD:HH:MM eller decimaltimer (fx 1,5).</li>
          </ul>
        </dd>

        <dt>Knapper</dt>
        <dd>
          <ul class="mb-2">
            <li><strong>Start</strong>: starter/stopper timeren (HH:MM:SS live).</li>
            <li><strong>Tilføj</strong>: gemmer posten (erstatter hvis du fortsætter en eksisterende inden for grænsen).</li>
            <li><strong>Start her</strong>: kopierer en række op og starter timeren; fortsætter/erstatter hvis inden for grænsen, ellers ny fra 0.</li>
            <li><strong>Dupliker</strong>: kopierer en række op (inkl. tid) uden at starte timeren.</li>
            <li><strong>Generér 102000 eksempelrækker</strong>: lægger prøve-data i databasen.</li>
            <li><strong>Slet alle rækker</strong>: tømmer databasen (kræver bekræftelse).</li>
          </ul>
        </dd>

        <dt>GET-parametre</dt>
        <dd>
          Du kan kalde siden med parametre for at udfylde felter og evt. starte/gemme:
<pre class="mb-2"><code>?datetime=2025-08-12T09:30:00
&amp;username=bruger@example.com
&amp;projektnr=2304571
&amp;aktivitet=8400
&amp;sag=SAG000123
&amp;opgave=Fejlretning
&amp;tid=01:30:00
&amp;action=timer|record|draft</code></pre>
          <ul>
            <li><code>datetime</code>: ISO (YYYY-MM-DDTHH:MM(:SS)) – vises som <strong>DD/MM/YYYY HH:MM:SS</strong>.</li>
            <li><code>username</code>, <code>projektnr</code> (7 cifre, 19–25xxxx), <code>aktivitet</code> (4 cifre), <code>sag</code>, <code>opgave</code>, <code>tid</code>.</li>
            <li><code>action</code>:
              <ul>
                <li><code>timer</code> – udfyld felter og <em>start</em> timeren.</li>
                <li><code>record</code> – udfyld og <em>gem straks</em> i IndexedDB (tilføjer en række).</li>
                <li><code>draft</code> – <em>kun udfyld</em> formularen, ingen timer/lagring.</li>
              </ul>
            </li>
          </ul>
          <div class="small-muted">Eksempel (timer):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=anna@firma.dk&amp;projektnr=2103478&amp;aktivitet=7200&amp;sag=SAG42&amp;opgave=Årshjul&amp;tid=01:00:00&amp;action=timer</code></div>
          <div class="small-muted mt-2">Eksempel (record):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=brian@eksempel.dk&amp;projektnr=2309876&amp;aktivitet=8400&amp;sag=SAG007&amp;opgave=Ændringsanmodning&amp;tid=2.5&amp;action=record</code></div>
          <div class="small-muted mt-2">Eksempel (draft):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=lotte@contoso.dk&amp;projektnr=1901200&amp;aktivitet=5600&amp;sag=SAG000777&amp;opgave=Køreplan&amp;tid=00:45:00&amp;action=draft</code></div>
        </dd>

        <dt>Eksport</dt>
        <dd>Eksport er <strong>Excel (.xlsx)</strong>. Dato/tid vises som <strong>DD/MM/YYYY HH:MM:SS</strong>, tid som <strong>HH:MM:SS</strong>. ÆØÅ bevares korrekt.</dd>
      </dl>
    </div>
  </div>

  <!-- Formular -->
  <div class="card p-3 shadow-sm">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Dato + tid:</label>
        <input type="text" id="datoVis" class="form-control" placeholder="dd/mm/yyyy hh:mm:ss" />
        <input type="hidden" id="dato" />
      </div>
      <div class="col-md-4">
        <label for="username" class="form-label">Brugernavn (e-mail):</label>
        <input type="email" id="username" class="form-control" placeholder="bruger@example.com" inputmode="email" autocomplete="username" />
      </div>
      <div class="col-md-4">
        <label for="projektnr" class="form-label">Projektnummer:</label>
        <input type="text" id="projektnr" class="form-control" placeholder="7-cifret projektnr" />
      </div>

      <div class="col-md-4">
        <label for="aktivitet" class="form-label">Aktivitetskode:</label>
        <input type="text" id="aktivitet" class="form-control" placeholder="4-cifret kode (fx 8400)" />
      </div>
      <div class="col-md-4">
        <label for="sag" class="form-label">Sag # (max 10)</label>
        <input type="text" id="sag" class="form-control" maxlength="10" placeholder="Sag #" />
      </div>
      <div class="col-md-4">
        <label for="opgave" class="form-label">Beskrivelse:</label>
        <input type="text" id="opgave" class="form-control" placeholder="Beskriv opgaven" />
      </div>

      <div class="col-md-3">
        <label for="timer" class="form-label">Tid (HH:MM:SS / DD:HH:MM / dec.)</label>
        <input type="text" id="timer" class="form-control" placeholder="00:00:00 eller 1,5" />
      </div>

      <div class="col-md-3 d-flex align-items-end gap-2">
        <button onclick="tilføjRegistrering()" class="btn btn-primary w-100">Tilføj</button>
        <button id="timerBtn" onclick="startStopTimer()" class="btn btn-success w-100">Start</button>
      </div>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="mt-4 d-flex align-items-center justify-content-between flex-wrap gap-2">
    <h4 class="m-0">Registreringer</h4>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="input-group" style="max-width: 420px;">
        <span class="input-group-text">Søg</span>
        <input id="searchInput" type="text" class="form-control" placeholder="Filtrér i tabellen...">
      </div>
      <button onclick="eksporterExcel()" class="btn btn-success btn-sm">Eksporter til Excel</button>
    </div>
  </div>

  <!-- Tabel -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered shadow-sm mt-2" id="regTable">
      <thead class="table-dark">
        <tr>
          <th class="sortable" data-col="dato">Dato + tid <span class="sort-ind"></span></th>
          <th class="sortable" data-col="username">Brugernavn <span class="sort-ind"></span></th>
          <th class="sortable" data-col="projektnr">Projektnr <span class="sort-ind"></span></th>
          <th class="sortable" data-col="aktivitet">Aktivitetskode <span class="sort-ind"></span></th>
          <th class="sortable" data-col="sag">Sag # <span class="sort-ind"></span></th>
          <th class="sortable" data-col="opgave">Beskrivelse <span class="sort-ind"></span></th>
          <th class="sortable" data-col="seconds">Tid (HH:MM:SS) <span class="sort-ind"></span></th>
          <th>Handling</th>
        </tr>
      </thead>
      <tbody id="tabelBody"></tbody>
    </table>
  </div>

  <!-- Paginering -->
  <nav class="d-flex justify-content-end" aria-label="Pagination">
    <ul class="pagination m-0">
      <li class="page-item"><button class="page-link" id="prevPage" onclick="gotoPrevPage()" type="button">Forrige</button></li>
      <li class="page-item disabled"><span class="page-link" id="pageInfo">Side 1 af 1</span></li>
      <li class="page-item"><button class="page-link" id="nextPage" onclick="gotoNextPage()" type="button">Næste</button></li>
    </ul>
  </nav>

  <footer class="mt-4">
    <div class="small-muted">Font: Montserrat © The Montserrat Project Authors. Licens: SIL Open Font License 1.1 (OFL).</div>
  </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/da.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
// ========= IndexedDB (NYT) =========
const DB_NAME = 'tidsregDB';
const DB_VERSION = 1;
const STORE = 'registreringer';

function openDB(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (e)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(STORE)){
        const os = db.createObjectStore(STORE, { keyPath: 'id', autoIncrement: true });
        os.createIndex('by_datoMs','_datoMs',{unique:false});
        os.createIndex('by_username','username',{unique:false});
        os.createIndex('by_projektnr','projektnr',{unique:false});
        os.createIndex('by_aktivitet','aktivitet',{unique:false});
        os.createIndex('by_sag','sag',{unique:false});
        os.createIndex('by_opgave','opgave',{unique:false});
        os.createIndex('by_seconds','seconds',{unique:false});
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function withStore(mode, fn){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, mode);
    const os = tx.objectStore(STORE);
    const res = fn(os, tx);
    tx.oncomplete = ()=> resolve(res);
    tx.onerror = ()=> reject(tx.error);
  });
}

function dbAdd(rec){
  return withStore('readwrite', os=> os.add(rec));
}
function dbUpdateById(id, rec){
  return withStore('readwrite', os=> os.put({...rec, id}));
}
function dbDeleteById(id){
  return withStore('readwrite', os=> os.delete(id));
}
function dbClear(){
  return withStore('readwrite', os=> os.clear());
}
function dbCount(){
  return withStore('readonly', os=> os.count());
}

// Hent side via cursor fra valgt indeks og retning, evt. fritekstfilter
async function dbPage({indexName, dir, page, pageSize, search}){
  const db = await openDB();
  const tx = db.transaction(STORE, 'readonly');
  const os = tx.objectStore(STORE);
  const idx = indexName ? os.index(indexName) : os;

  const direction = dir==='asc'?'next':'prev';
  let results = [];
  let matchedSeen = 0; // antal match ramt (for at skippe sider)
  const startFrom = (page-1)*pageSize;

  return new Promise((resolve, reject)=>{
    const req = idx.openCursor(null, direction);
    req.onerror = ()=> reject(req.error);
    req.onsuccess = ()=>{
      const cursor = req.result;
      if(!cursor){ return resolve(results); }
      const v = cursor.value;
      if(matchesSearch(v, search)){
        if(matchedSeen >= startFrom){
          results.push(v);
          if(results.length>=pageSize){ return resolve(results); }
        }
        matchedSeen++;
      }
      cursor.continue();
    };
  });
}

// Tæl med fritekstfilter (hvis tom: brug count())
async function dbCountFiltered({search, indexName}){
  if(!search){ 
    // hurtig count på primær indeks (eller valgfrit indeks)
    return withStore('readonly', os=> (indexName? os.index(indexName):os).count());
  }
  // ellers iterér og tæl
  const db = await openDB();
  const tx = db.transaction(STORE, 'readonly');
  const os = tx.objectStore(STORE);
  const idx = indexName ? os.index(indexName) : os;
  let count=0;
  return new Promise((resolve, reject)=>{
    const req = idx.openCursor();
    req.onerror = ()=> reject(req.error);
    req.onsuccess = ()=>{
      const cursor = req.result;
      if(!cursor) return resolve(count);
      if(matchesSearch(cursor.value, search)) count++;
      cursor.continue();
    };
  });
}

// ========= Utils =========
function pad2(n){ return String(n).padStart(2,'0'); }
function toLocalIsoNoTZ(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  const h=pad2(d.getHours()), mi=pad2(d.getMinutes()), s=pad2(d.getSeconds());
  return `${y}-${m}-${da}T${h}:${mi}:${s}`;
}
function fromLocalIsoNoTZ(str){
  const m=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})$/.exec(str);
  if(!m) return new Date(NaN);
  const Y=+m[1], Mo=+m[2], D=+m[3], H=+m[4], Mi=+m[5], S=+m[6];
  return new Date(Y,Mo-1,D,H,Mi,S,0);
}
function formatDa_ddmmyyyy_hhmmss(localIsoStr){
  const d = fromLocalIsoNoTZ(localIsoStr);
  if (isNaN(d)) return localIsoStr || '';
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}
function formatHMS(totalSeconds){
  const hh=pad2(Math.floor(totalSeconds/3600));
  const mm=pad2(Math.floor((totalSeconds%3600)/60));
  const ss=pad2(totalSeconds%60);
  return `${hh}:${mm}:${ss}`;
}
function parseHMStoSeconds(v){
  const p=v.split(':'); if(p.length<2||p.length>3) return null;
  const hh=parseInt(p[0]||'0',10), mm=parseInt(p[1]||'0',10), ss=parseInt((p[2]||'0'),10);
  if([hh,mm,ss].some(n=>Number.isNaN(n)||n<0)) return null;
  return hh*3600+mm*60+ss;
}
function parseDDHHMMtoSeconds(v){
  const p=v.split(':'); if(p.length!==3) return null;
  const dd=parseInt(p[0]||'0',10), hh=parseInt(p[1]||'0',10), mm=parseInt(p[2]||'0',10);
  if([dd,hh,mm].some(n=>Number.isNaN(n)||n<0)) return null;
  return dd*86400+hh*3600+mm*60;
}
function isValidEmail(v){
  if(!v) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
}

// ========= Søge/visningshjælp =========
function matchesSearch(r, q){
  if(!q) return true;
  const s = q.trim().toLowerCase();
  const fields = [
    formatDa_ddmmyyyy_hhmmss(r.dato||''),
    r.username||'', r.projektnr||'', r.aktivitet||'', r.sag||'', r.opgave||'',
    formatHMS(Number.isFinite(r.seconds)?r.seconds:0)
  ].join(' ').toLowerCase();
  return fields.includes(s);
}
function indexNameForSort(col){
  switch(col){
    case 'dato': return 'by_datoMs';
    case 'username': return 'by_username';
    case 'projektnr': return 'by_projektnr';
    case 'aktivitet': return 'by_aktivitet';
    case 'sag': return 'by_sag';
    case 'opgave': return 'by_opgave';
    case 'seconds': return 'by_seconds';
    default: return 'by_datoMs';
  }
}

// ========= UI state =========
let currentSort = { col:'dato', dir:'desc' };
let currentSearch = '';
const pageSize = 50;
let currentPage = 1;

// ========= Flatpickr =========
function initDatePicker(now){
  document.getElementById('dato').value = toLocalIsoNoTZ(now);
  flatpickr("#datoVis", {
    enableTime:true, time_24hr:true, enableSeconds:true,
    dateFormat:"d/m/Y H:i:S", locale: flatpickr.l10ns.da,
    defaultDate: now,
    onChange: (dates)=>{ if(dates && dates[0]) document.getElementById('dato').value = toLocalIsoNoTZ(dates[0]); }
  });
  document.getElementById('datoVis')._flatpickr.setDate(now, true);
}

// ========= Pagination helpers =========
function totalPages(total){ return Math.max(1, Math.ceil(total / pageSize)); }
function clampPage(p, maxp){ return Math.min(Math.max(1, p), maxp); }
function gotoPage(p){ currentPage = p; visRegistreringer(); }
function gotoPrevPage(){ gotoPage(currentPage-1); }
function gotoNextPage(){ gotoPage(currentPage+1); }

function renderPagination(totalCount){
  const maxp = totalPages(totalCount);
  currentPage = clampPage(currentPage, maxp);
  document.getElementById('pageInfo').textContent = `Side ${currentPage} af ${maxp}`;
  document.getElementById('prevPage').disabled = currentPage <= 1;
  document.getElementById('nextPage').disabled = currentPage >= maxp;
}

// ========= Tabelrender (IndexedDB) =========
async function visRegistreringer(){
  const tbody = document.getElementById('tabelBody');
  tbody.innerHTML = '';

  const indexName = indexNameForSort(currentSort.col);
  const rows = await dbPage({
    indexName,
    dir: currentSort.dir,
    page: currentPage,
    pageSize,
    search: currentSearch
  });
  const total = await dbCountFiltered({search: currentSearch, indexName});

  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDa_ddmmyyyy_hhmmss(r.dato)}</td>
      <td>${r.username||''}</td>
      <td>${r.projektnr||''}</td>
      <td>${r.aktivitet||''}</td>
      <td>${r.sag||''}</td>
      <td>${r.opgave||''}</td>
      <td>${formatHMS(r.seconds||0)}</td>
      <td></td>
    `;
    const actions = tr.lastElementChild;

    const startBtn = document.createElement('button');
    startBtn.className='btn btn-sm btn-outline-success me-1';
    startBtn.textContent='Start her';
    startBtn.onclick = ()=> startFromRow(r.id);
    actions.appendChild(startBtn);

    const dupBtn = document.createElement('button');
    dupBtn.className='btn btn-sm btn-outline-primary me-1';
    dupBtn.textContent='Dupliker';
    dupBtn.onclick = ()=> duplicateToForm(r.id);
    actions.appendChild(dupBtn);

    const delBtn = document.createElement('button');
    delBtn.className='btn btn-sm btn-danger';
    delBtn.textContent='Slet';
    delBtn.onclick = async ()=>{
      if(confirm('Slette denne registrering?')){
        await dbDeleteById(r.id);
        visRegistreringer();
      }
    };
    actions.appendChild(delBtn);

    tbody.appendChild(tr);
  });

  renderPagination(total);

  document.querySelectorAll('th.sortable .sort-ind').forEach(el=>el.textContent='');
  const th = document.querySelector(`th.sortable[data-col="${currentSort.col}"] .sort-ind`);
  if(th) th.textContent = currentSort.dir==='asc'?'▲':'▼';
}

// ========= Timer-state =========
let timerInterval=null, startTimeMs=null, accumulatedSeconds=0;
let editingId=null, resumeReplace=false;

function setForm(r){
  document.getElementById('dato').value = r.dato;
  const d = fromLocalIsoNoTZ(r.dato);
  document.getElementById('datoVis')._flatpickr.setDate(d, true);
  document.getElementById('username').value = r.username||'';
  document.getElementById('projektnr').value = r.projektnr||'';
  document.getElementById('aktivitet').value = r.aktivitet||'';
  document.getElementById('opgave').value = r.opgave||'';
  document.getElementById('sag').value = r.sag||'';
}
function stopTimerUI(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  document.getElementById('timerBtn').textContent='Start';
}
function startTimerUIFromSeconds(seconds){
  accumulatedSeconds=seconds;
  startTimeMs = Date.now() - seconds*1000;
  document.getElementById('timerBtn').textContent='Stop';
  document.getElementById('timer').value = formatHMS(accumulatedSeconds);
  timerInterval = setInterval(()=>{
    const totalSeconds = Math.floor((Date.now()-startTimeMs)/1000);
    document.getElementById('timer').value = formatHMS(totalSeconds);
  }, 250);
}

async function getById(id){
  const db = await openDB();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(STORE, 'readonly');
    const os = tx.objectStore(STORE);
    const req = os.get(id);
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}

async function startFromRow(id){
  const r = await getById(id);
  if(!r) return;
  const thresholdMin = getThresholdMinutes();
  const recordTimeMs = r.dato ? fromLocalIsoNoTZ(r.dato).getTime() : Date.now();
  const withinWindow = (Date.now() - recordTimeMs) <= thresholdMin*60*1000;

  const copy = { ...r };
  if(withinWindow) copy.dato = toLocalIsoNoTZ(new Date());
  setForm(copy);

  const baseline = withinWindow ? (Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600)) : 0;
  editingId = withinWindow ? r.id : null;
  resumeReplace = withinWindow;

  stopTimerUI();
  startTimerUIFromSeconds(baseline);
}

async function duplicateToForm(id){
  const r = await getById(id);
  if(!r) return;
  setForm(r);
  const seconds = Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600);
  document.getElementById('timer').value = formatHMS(seconds);
  stopTimerUI();
  accumulatedSeconds=0;
  editingId=null;
  resumeReplace=false;
}

function startStopTimer(){
  const btn=document.getElementById('timerBtn');
  if(timerInterval){
    const runningSeconds=Math.floor((Date.now()-startTimeMs)/1000);
    accumulatedSeconds=runningSeconds;
    clearInterval(timerInterval); timerInterval=null;
    btn.textContent='Start';
    document.getElementById('timer').value = formatHMS(accumulatedSeconds);
    return;
  }
  let baseline=0, v=(document.getElementById('timer').value||'').trim();
  if(v.includes(':')){
    baseline = parseHMStoSeconds(v);
    if(baseline==null) baseline = parseDDHHMMtoSeconds(v) ?? 0;
  } else if(v){
    const num=parseFloat(v.replace(',', '.')); if(!Number.isNaN(num)&&num>=0) baseline=Math.round(num*3600);
  }
  startTimerUIFromSeconds(baseline);
}

// ========= Tilføj/Gem =========
async function tilføjRegistrering(){
  const datoIso = document.getElementById('dato').value;
  const username = document.getElementById('username').value.trim();
  const projektnr = document.getElementById('projektnr').value.trim();
  const aktivitet = document.getElementById('aktivitet').value.trim();
  const opgave = document.getElementById('opgave').value.trim();
  const sag = document.getElementById('sag').value.trim();
  let t = (document.getElementById('timer').value||'').trim();

  if(!datoIso || !username || !projektnr || !aktivitet || !opgave || !t){
    alert('Udfyld alle felter (inkl. brugernavn).'); return;
  }
  if(!isValidEmail(username)){ alert('Ugyldig e-mailadresse i Brugernavn.'); return; }

  let totalSeconds;
  if(timerInterval){
    totalSeconds = Math.floor((Date.now()-startTimeMs)/1000);
  } else if(t.includes(':')){
    let s=parseHMStoSeconds(t); if(s==null) s=parseDDHHMMtoSeconds(t);
    if(s==null){ alert('Ugyldigt tidsformat. Brug HH:MM:SS, DD:HH:MM eller decimaltal.'); return; }
    totalSeconds=s;
  } else {
    const num=parseFloat(t.replace(',', '.'));
    if(Number.isNaN(num)){ alert('Tid skal være et tal eller HH:MM:SS / DD:HH:MM'); return; }
    totalSeconds = Math.round(num*3600);
  }

  const now = Date.now();
  const rec = { 
    dato:datoIso, 
    _datoMs: fromLocalIsoNoTZ(datoIso).getTime(),
    username, projektnr, aktivitet, opgave, sag, 
    seconds:totalSeconds, timer: totalSeconds/3600, savedAt: now 
  };

  if(resumeReplace && editingId!=null){
    await dbUpdateById(editingId, {...rec, id:editingId});
  } else {
    await dbAdd(rec);
  }

  // nulstil form + timer
  const dNow=new Date();
  document.getElementById('dato').value = toLocalIsoNoTZ(dNow);
  document.getElementById('datoVis')._flatpickr.setDate(dNow, true);
  document.getElementById('username').value='';
  document.getElementById('projektnr').value='';
  document.getElementById('aktivitet').value='';
  document.getElementById('opgave').value='';
  document.getElementById('sag').value='';
  document.getElementById('timer').value='';
  accumulatedSeconds=0; editingId=null; resumeReplace=false;
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  document.getElementById('timerBtn').textContent='Start';

  visRegistreringer();
}

// ========= Excel-eksport =========
async function eksporterExcel(){
  const indexName = indexNameForSort(currentSort.col);
  const direction = currentSort.dir==='asc'?'next':'prev';
  const db = await openDB();
  const tx = db.transaction(STORE, 'readonly');
  const os = tx.objectStore(STORE);
  const idx = os.index(indexName);
  const rows = [];
  await new Promise((resolve, reject)=>{
    const req = idx.openCursor(null, direction);
    req.onerror = ()=> reject(req.error);
    req.onsuccess = ()=>{
      const cursor = req.result;
      if(!cursor) return resolve();
      const v = cursor.value;
      if(matchesSearch(v, currentSearch)) rows.push(v);
      cursor.continue();
    };
  });

  if(rows.length===0){ alert('Der er ingen registreringer at eksportere.'); return; }

  const header = ['DatoTid','Brugernavn','Projektnr','Aktivitetskode','Sag','Beskrivelse','Tid'];
  const data = rows.map(r=>[
    formatDa_ddmmyyyy_hhmmss(r.dato),
    r.username||'',
    r.projektnr||'',
    r.aktivitet||'',
    r.sag||'',
    (r.opgave||'').replaceAll(';', ','),
    formatHMS(r.seconds||0)
  ]);
  const aoa = [header, ...data];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  ws['!cols'] = [{wch:20},{wch:28},{wch:14},{wch:16},{wch:10},{wch:40},{wch:12}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Tidsregistrering');
  XLSX.writeFile(wb, 'tidsregistrering.xlsx');
}

// ========= Sample data (102000) =========
function randomChoice(a){ return a[Math.floor(Math.random()*a.length)]; }
function genProjektnr(){
  const prefixes = ['19','20','21','22','23','24','25'];
  const p = randomChoice(prefixes);
  const rest = String(Math.floor(Math.random()*100000)).padStart(5,'0');
  return p + rest; // 7 cifre
}
const aktivitetskoder = [1200,1400,1600,1800,2000,2400,2800,3200,3600,4000,4400,4800,5200,5600,6000,6400,7200,7600,8000,8400].map(String);
const emails = [
  'anna@firma.dk','brian@eksempel.dk','camilla@contoso.dk','dennis@firma.dk','eva@eksempel.dk',
  'frank@firma.dk','grete@contoso.dk','henrik@firma.dk','ivor@eksempel.dk','julie@firma.dk',
  'kasper@contoso.dk','lars@firma.dk','maria@eksempel.dk','niels@firma.dk','ole@contoso.dk',
  'pia@firma.dk','rasmus@eksempel.dk','sara@firma.dk','tina@contoso.dk','ulrik@firma.dk'
];
const opgaver = [
  'Fejlretning','Review','Dokumentation','Møde','Feature',
  'Årshjul','Sagsåbning','Køreplan','Kørebog','Årsafslutning',
  'Ændringsanmodning','Kvalitetssikring','Brugeroprettelse','Rådgivning',
  'Opgradering','Vedligehold','Tilpasning','Implementering','Planlægning','Udrulning'
];

async function generateSampleData(){
  const WANT = 102000;
  if(!confirm(`Oprette ${WANT} eksempelrækker i IndexedDB?`)) return;

  const db = await openDB();
  const tx = db.transaction(STORE, 'readwrite');
  const os = tx.objectStore(STORE);

  const now = new Date();
  const BATCH_LOG = 2000;
  for(let i=0;i<WANT;i++){
    const d = new Date(now.getTime() - Math.floor(Math.random()*30)*86400000 - Math.floor(Math.random()*8)*3600000);
    const seconds = 900 * (1 + Math.floor(Math.random()*20)); // 15-min steps
    const rec = {
      dato: toLocalIsoNoTZ(d),
      _datoMs: d.getTime(),
      username: randomChoice(emails),
      projektnr: genProjektnr(),
      aktivitet: randomChoice(aktivitetskoder),
      opgave: randomChoice(opgaver) + ' #' + (i+1),
      sag: String(10000 + i),
      seconds,
      timer: seconds/3600,
      savedAt: Date.now()
    };
    os.add(rec);
    if(i>0 && i % BATCH_LOG === 0){
      console.log(`Indsat ${i}…`);
      // yield lidt til UI
      await new Promise(r=>setTimeout(r,0));
    }
  }

  tx.oncomplete = ()=>{ 
    console.log('Færdig: 102000 rækker oprettet.');
    currentPage = 1; visRegistreringer(); 
    alert('Færdig: 102000 rækker oprettet.');
  };
  tx.onerror = ()=> alert('Fejl under generering: ' + tx.error);
}

async function deleteAllData(){
  if(!confirm('Slette alle rækker? Dette kan ikke fortrydes.')) return;
  await dbClear();
  currentPage = 1;
  visRegistreringer();
}

// ========= GET-parametre =========
function applyQueryParams(){
  const q=new URLSearchParams(window.location.search);
  if(![...q.keys()].length) return;
  const setIf=(id,val)=>{ if(val!=null && val!=='') document.getElementById(id).value=val; };

  const dt=q.get('datetime');
  if(dt){
    const d=new Date(dt);
    if(!isNaN(d)){
      document.getElementById('dato').value = toLocalIsoNoTZ(d);
      document.getElementById('datoVis')._flatpickr.setDate(d, true);
    }
  }
  setIf('username', q.get('username'));
  setIf('projektnr', q.get('projektnr'));
  setIf('aktivitet', q.get('aktivitet'));
  setIf('sag', q.get('sag'));
  setIf('opgave', q.get('opgave'));

  const tid=q.get('tid');
  const action=(q.get('action')||'').toLowerCase();

  if(tid){
    let seconds=null;
    if(tid.includes(':')){ seconds=parseHMStoSeconds(tid); if(seconds==null) seconds=parseDDHHMMtoSeconds(tid); }
    else { const num=parseFloat(tid.replace(',','.')); if(!Number.isNaN(num)) seconds=Math.round(num*3600); }
    if(seconds!=null){
      document.getElementById('timer').value = formatHMS(seconds);
      if(action==='timer'){ stopTimerUI(); startTimerUIFromSeconds(seconds); }
      if(action==='record'){ 
        // gem direkte
        const rec = buildRecFromForm(seconds);
        dbAdd(rec).then(()=> visRegistreringer());
      }
    }
  } else {
    if(action==='timer'){ stopTimerUI(); startTimerUIFromSeconds(0); }
  }
}

function buildRecFromForm(seconds){
  const datoIso = document.getElementById('dato').value;
  return {
    dato: datoIso,
    _datoMs: fromLocalIsoNoTZ(datoIso).getTime(),
    username: document.getElementById('username').value.trim(),
    projektnr: document.getElementById('projektnr').value.trim(),
    aktivitet: document.getElementById('aktivitet').value.trim(),
    opgave: document.getElementById('opgave').value.trim(),
    sag: document.getElementById('sag').value.trim(),
    seconds: seconds,
    timer: seconds/3600,
    savedAt: Date.now()
  };
}

// ========= Init =========
document.addEventListener('DOMContentLoaded', async ()=>{
  const now=new Date();
  initDatePicker(now);

  // Søg
  document.getElementById('searchInput').addEventListener('input', (e)=>{
    currentSearch = e.target.value || '';
    currentPage = 1;
    visRegistreringer();
  });

  // Sort cols
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const col = th.getAttribute('data-col');
      if(currentSort.col===col){
        currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
      }else{
        currentSort.col=col; currentSort.dir='asc';
      }
      currentPage = 1;
      visRegistreringer();
    });
  });

  // Resume threshold
  const saved=localStorage.getItem('resumeThresholdMin');
  document.getElementById('resumeThreshold').value = saved ?? '10';
  document.getElementById('resumeThreshold').addEventListener('change', ()=>{
    const v=document.getElementById('resumeThreshold').value;
    const n=parseInt(v,10);
    localStorage.setItem('resumeThresholdMin',(!Number.isNaN(n)&&n>=0)? String(n):'10');
  });

  // Settings
  document.getElementById('btnGenSample').addEventListener('click', generateSampleData);
  document.getElementById('btnDeleteAll').addEventListener('click', deleteAllData);

  await openDB(); // sikrer DB init/indeks
  applyQueryParams();
  visRegistreringer();
});

// ESC: ryd formular
function clearForm() {
  const dNow = new Date();
  document.getElementById('dato').value = toLocalIsoNoTZ(dNow);
  document.getElementById('datoVis')._flatpickr.setDate(dNow, true);
  document.getElementById('username').value = '';
  document.getElementById('projektnr').value = '';
  document.getElementById('aktivitet').value = '';
  document.getElementById('opgave').value = '';
  document.getElementById('sag').value = '';
  document.getElementById('timer').value = '';
  accumulatedSeconds = 0;
  editingId = null;
  resumeReplace = false;
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  document.getElementById('timerBtn').textContent = 'Start';
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') clearForm();
});
</script>
</body>
</html>
