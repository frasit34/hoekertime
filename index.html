<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tidsregistrering</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
  body { font-family: Arial, sans-serif; max-width: 980px; margin: auto; padding: 20px; background:#fff; }
  h1 { text-align: center; margin-bottom: 8px; }
  .sub { text-align:center; color:#555; margin-bottom: 20px; }
  .section { border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:16px; }
  label { font-weight: bold; }
  .row { display:flex; flex-wrap:wrap; gap:12px; }
  .col { flex:1 1 280px; min-width:260px; }
  input[type="text"], input[type="email"], input[type="number"], input[type="date"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; }
  .actions { display:flex; gap:8px; }
  button { padding:8px 12px; border:1px solid #999; background:#f5f5f5; border-radius:6px; cursor:pointer; }
  button.primary { background:#1976d2; color:#fff; border-color:#1976d2; }
  button.success { background:#2e7d32; color:#fff; border-color:#2e7d32; }
  button.danger { background:#c62828; color:#fff; border-color:#c62828; }
  button.outline { background:#fff; }
  .small { font-size:12px; color:#555; }
  .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 8px; text-align: left; }
  th.sortable { cursor:pointer; user-select:none; }
  th.sortable .ind { opacity:.6; margin-left:.25rem; }
  .pagination { display:flex; align-items:center; gap:6px; }
  .help pre, .help code { background:#f7f7f7; padding:3px 6px; border-radius:4px; }
  .hidden { display:none; }
</style>
</head>
<body>
  <h1>Tidsregistrering</h1>
  <div class="sub">Simpel tidsregistrering med timer, duplikering, søgning, sortering, paginering og CSV‑eksport.</div>

  <!-- Indstillinger & Hjælp toggles -->
  <div class="actions" style="justify-content:flex-end; margin-bottom:8px;">
    <button id="btnToggleSettings" class="outline">Indstillinger</button>
    <button id="btnToggleHelp" class="outline">Hjælp</button>
  </div>

  <!-- Indstillinger -->
  <div id="settingsPanel" class="section hidden">
    <h3 style="margin-top:0">Indstillinger</h3>
    <div class="row">
      <div class="col">
        <label for="resumeThreshold">Fortsæt hvis arkiveret inden (minutter)</label>
        <input type="number" id="resumeThreshold" min="0" step="1" placeholder="10" />
        <div class="small">Bruges af <em>Start her</em>. Er posten yngre end denne grænse, fortsættes tiden og <b>Tilføj</b> erstatter samme post. Ellers startes fra 0 og der oprettes en ny post.</div>
      </div>
    </div>
    <hr>
    <div class="row">
      <div class="col">
        <button id="btnGenSamples" class="outline">Opret 102 eksempelrækker</button>
        <div class="small">Opretter 102 demoposter (til test af søg/sort/paginering). Bekræftes først.</div>
      </div>
      <div class="col">
        <button id="btnDeleteAll" class="danger">Slet alle rækker</button>
        <div class="small">Tømmer alle registreringer permanent. Bekræftes først.</div>
      </div>
    </div>
  </div>

  <!-- Hjælp -->
  <div id="helpPanel" class="section hidden help">
    <h3 style="margin-top:0">Hjælp & guide</h3>
    <p>Appen kører lokalt i din browser og gemmer i <em>LocalStorage</em> (offline). Du kan:</p>
    <ul>
      <li><b>Start</b>: Start/stop timeren. Visning i HH:MM:SS.</li>
      <li><b>Tilføj</b>: Gemmer posten. Ved fortsættelse (inden for grænsen) erstattes samme post.</li>
      <li><b>Start her</b>: Kopiér en række op og start timer. Fortsætter/erstatter hvis inden for grænsen, ellers starter fra 0 og laver ny post.</li>
      <li><b>Dupliker</b>: Kopiér en række op (inkl. tid) uden at starte timeren.</li>
      <li><b>Søg</b>, <b>klik‑sortér</b> og <b>paginér</b> (50 pr. side).</li>
      <li><b>Eksport</b>: CSV med UTF‑8 BOM (æøå), dato/tid som DD/MM/YYYY HH:MM:SS og tid som HH:MM:SS.</li>
    </ul>
    <h4>GET‑parametre</h4>
    <p>Forudfyld felter og evt. start/gem automatisk via URL‑parametre:</p>
    <ul>
      <li><code>datetime</code>: <code>YYYY-MM-DDTHH:MM(:SS)</code> (vises som DD/MM/YYYY HH:MM:SS)</li>
      <li><code>username</code>: e‑mail (kræves ved gem)</li>
      <li><code>projektnr</code>, <code>aktivitet</code>, <code>sag</code> (max 10), <code>opgave</code></li>
      <li><code>tid</code>: <code>HH:MM:SS</code> eller <code>DD:HH:MM</code> eller decimaltimer (1.5/1,5)</li>
      <li><code>action</code>: <code>timer</code> (start tæller), <code>record</code> (gem), <code>draft</code> (kun udfyld)</li>
    </ul>
    <div class="small"><b>Eksempel</b> (basis‑URL uden filnavn):
      <div><code>https://example.com/tid/?datetime=2025-08-12T09:30:00&username=bruger@example.com&projektnr=PRJ1&aktivitet=QA&sag=SAG42&opgave=Test&tid=2.5&action=record</code></div>
    </div>
  </div>

  <!-- Formular -->
  <div class="section">
    <h3 style="margin-top:0">Ny registrering</h3>
    <div class="row">
      <div class="col">
        <label>Dato + tid</label>
        <input type="text" id="datoVis" placeholder="dd/mm/yyyy hh:mm:ss" />
        <input type="hidden" id="dato" />
      </div>
      <div class="col">
        <label for="username">Brugernavn (e‑mail)</label>
        <input type="email" id="username" placeholder="bruger@example.com" inputmode="email" autocomplete="username" />
      </div>
      <div class="col">
        <label for="projektnr">Projektnummer</label>
        <input type="text" id="projektnr" placeholder="Projektnummer" />
      </div>
      <div class="col">
        <label for="aktivitet">Aktivitetskode</label>
        <input type="text" id="aktivitet" placeholder="Aktivitetskode" />
      </div>
      <div class="col">
        <label for="sag">Sag # (max 10)</label>
        <input type="text" id="sag" maxlength="10" placeholder="Sag #" />
      </div>
      <div class="col">
        <label for="opgave">Beskrivelse</label>
        <input type="text" id="opgave" placeholder="Beskriv opgaven" />
      </div>
      <div class="col">
        <label for="timer">Tid (HH:MM:SS / DD:HH:MM / dec.)</label>
        <input type="text" id="timer" placeholder="00:00:00 eller 1,5" />
      </div>
    </div>
    <div class="actions" style="margin-top:8px;">
      <button class="primary" onclick="tilføjRegistrering()">Tilføj</button>
      <button id="timerBtn" class="success" onclick="startStopTimer()">Start</button>
    </div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar section">
    <strong>Registreringer</strong>
    <div class="actions">
      <input id="searchInput" type="text" placeholder="Søg i tabellen..." />
      <button class="outline" onclick="eksporterCSV()">Eksporter CSV</button>
      <div class="pagination">
        <button id="prevPage" class="outline" onclick="gotoPrevPage()">Forrige</button>
        <span id="pageInfo" class="small">Side 1 af 1</span>
        <button id="nextPage" class="outline" onclick="gotoNextPage()">Næste</button>
      </div>
    </div>
  </div>

  <!-- Tabel -->
  <div class="section">
    <table id="regTable">
      <thead>
        <tr>
          <th class="sortable" data-col="dato">Dato + tid <span class="ind"></span></th>
          <th class="sortable" data-col="username">Brugernavn <span class="ind"></span></th>
          <th class="sortable" data-col="projektnr">Projektnr <span class="ind"></span></th>
          <th class="sortable" data-col="aktivitet">Aktivitetskode <span class="ind"></span></th>
          <th class="sortable" data-col="sag">Sag # <span class="ind"></span></th>
          <th class="sortable" data-col="opgave">Beskrivelse <span class="ind"></span></th>
          <th class="sortable" data-col="seconds">Tid (HH:MM:SS) <span class="ind"></span></th>
          <th>Handling</th>
        </tr>
      </thead>
      <tbody id="tabelBody"></tbody>
    </table>
  </div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/da.js"></script>
<script>
// ===== Utils =====
function pad2(n){ return String(n).padStart(2,'0'); }
function toLocalIsoNoTZ(d){ const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate()); const h=pad2(d.getHours()), mi=pad2(d.getMinutes()), s=pad2(d.getSeconds()); return `${y}-${m}-${da}T${h}:${mi}:${s}`; }
function fromLocalIsoNoTZ(str){ const m=/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/.exec(str); if(!m) return new Date(NaN); const Y=+m[1], Mo=+m[2], D=+m[3], H=+m[4], Mi=+m[5], S=+m[6]; return new Date(Y,Mo-1,D,H,Mi,S,0); }
function formatDa(localIsoStr){ const d = fromLocalIsoNoTZ(localIsoStr); if(isNaN(d)) return localIsoStr||''; return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`; }
function formatHMS(sec){ const hh=pad2(Math.floor(sec/3600)); const mm=pad2(Math.floor((sec%3600)/60)); const ss=pad2(sec%60); return `${hh}:${mm}:${ss}`; }
function parseHMS(v){ const p=v.split(':'); if(p.length<2||p.length>3) return null; const hh=parseInt(p[0]||'0',10), mm=parseInt(p[1]||'0',10), ss=parseInt(p[2]||'0',10); if([hh,mm,ss].some(n=>Number.isNaN(n)||n<0)) return null; return hh*3600+mm*60+ss; }
function parseDDHHMM(v){ const p=v.split(':'); if(p.length!==3) return null; const dd=parseInt(p[0]||'0',10), hh=parseInt(p[1]||'0',10), mm=parseInt(p[2]||'0',10); if([dd,hh,mm].some(n=>Number.isNaN(n)||n<0)) return null; return dd*86400+hh*3600+mm*60; }
function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v||''); }

// ===== Storage =====
function hentRegistreringer(){ return JSON.parse(localStorage.getItem('registreringer')||'[]'); }
function gemRegistreringer(rs){ localStorage.setItem('registreringer', JSON.stringify(rs)); }
function getThresholdMinutes(){ const ui=parseInt(document.getElementById('resumeThreshold').value||'',10); if(!Number.isNaN(ui)&&ui>=0) return ui; const ls=parseInt(localStorage.getItem('resumeThresholdMin')||'',10); return Number.isNaN(ls)?10:ls; }
function setThresholdToUI(){ const saved=localStorage.getItem('resumeThresholdMin'); document.getElementById('resumeThreshold').value = saved ?? '10'; }

// ===== UI state =====
let currentSort={col:'dato',dir:'desc'}; let currentSearch=''; const pageSize=50; let currentPage=1;

// ===== Timer state =====
let timerInterval=null, startTimeMs=null, accumulatedSeconds=0; let editingIndex=null, resumeReplace=false;

// ===== Datepicker =====
function initDatePicker(now){
  document.getElementById('dato').value = toLocalIsoNoTZ(now);
  flatpickr('#datoVis', { enableTime:true, time_24hr:true, enableSeconds:true, dateFormat:'d/m/Y H:i:S', locale: flatpickr.l10ns.da, defaultDate: now,
    onChange:(dates)=>{ if(dates&&dates[0]) document.getElementById('dato').value = toLocalIsoNoTZ(dates[0]); }
  });
  document.getElementById('datoVis')._flatpickr.setDate(now,true);
}

// ===== Helpers =====
function setForm(r){ document.getElementById('dato').value=r.dato; document.getElementById('datoVis')._flatpickr.setDate(fromLocalIsoNoTZ(r.dato), true); document.getElementById('username').value=r.username||''; document.getElementById('projektnr').value=r.projektnr||''; document.getElementById('aktivitet').value=r.aktivitet||''; document.getElementById('sag').value=r.sag||''; document.getElementById('opgave').value=r.opgave||''; }
function stopTimerUI(){ if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } document.getElementById('timerBtn').textContent='Start'; }
function startTimerUIFromSeconds(seconds){ accumulatedSeconds=seconds; startTimeMs=Date.now()-seconds*1000; document.getElementById('timerBtn').textContent='Stop'; document.getElementById('timer').value=formatHMS(accumulatedSeconds); timerInterval=setInterval(()=>{ const total=Math.floor((Date.now()-startTimeMs)/1000); document.getElementById('timer').value=formatHMS(total); },250); }

// ===== Start her / Dupliker =====
function startFromRow(index){ const all=hentRegistreringer(); const r=all[index]; if(!r) return; const within=(Date.now()-fromLocalIsoNoTZ(r.dato).getTime())<= getThresholdMinutes()*60*1000; const copy={...r}; if(within){ const now=new Date(); copy.dato=toLocalIsoNoTZ(now); }
  setForm(copy);
  const baseline = within ? (Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600)) : 0;
  editingIndex = within ? index : null; resumeReplace = within; stopTimerUI(); startTimerUIFromSeconds(baseline); }
function duplicateToForm(index){ const all=hentRegistreringer(); const r=all[index]; if(!r) return; setForm(r); const seconds=Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600); document.getElementById('timer').value=formatHMS(seconds); stopTimerUI(); accumulatedSeconds=0; editingIndex=null; resumeReplace=false; }

// ===== Tilføj =====
function tilføjRegistrering(){ const datoIso=document.getElementById('dato').value; const username=(document.getElementById('username').value||'').trim(); const projektnr=document.getElementById('projektnr').value; const aktivitet=document.getElementById('aktivitet').value; const sag=document.getElementById('sag').value; const opgave=document.getElementById('opgave').value; let t=(document.getElementById('timer').value||'').trim(); if(!datoIso||!username||!projektnr||!aktivitet||!opgave||!t){ alert('Udfyld alle felter (inkl. brugernavn).'); return; } if(!isValidEmail(username)){ alert('Ugyldig e‑mailadresse.'); return; }
  let totalSeconds; if(timerInterval){ totalSeconds=Math.floor((Date.now()-startTimeMs)/1000); } else if(t.includes(':')){ let s=parseHMS(t); if(s==null) s=parseDDHHMM(t); if(s==null){ alert('Ugyldigt tidsformat. Brug HH:MM:SS, DD:HH:MM eller decimaltal.'); return; } totalSeconds=s; } else { const num=parseFloat(t.replace(',','.')); if(Number.isNaN(num)){ alert('Tid skal være tal eller HH:MM:SS / DD:HH:MM'); return; } totalSeconds=Math.round(num*3600); }
  const rec={ dato:datoIso, username, projektnr, aktivitet, sag, opgave, seconds:totalSeconds, timer: totalSeconds/3600, savedAt: Date.now() };
  const all=hentRegistreringer(); if(resumeReplace && editingIndex!=null && all[editingIndex]){ all[editingIndex]=rec; } else { all.push(rec); }
  gemRegistreringer(all);
  // reset
  const now=new Date(); document.getElementById('dato').value=toLocalIsoNoTZ(now); document.getElementById('datoVis')._flatpickr.setDate(now,true); document.getElementById('username').value=''; document.getElementById('projektnr').value=''; document.getElementById('aktivitet').value=''; document.getElementById('sag').value=''; document.getElementById('opgave').value=''; document.getElementById('timer').value=''; accumulatedSeconds=0; editingIndex=null; resumeReplace=false; if(timerInterval){ clearInterval(timerInterval); timerInterval=null; } document.getElementById('timerBtn').textContent='Start';
  visRegistreringer(); }

// ===== Søg + Sort + Pagination =====
function getDisplayRows(){ const rows=hentRegistreringer().map((r,idx)=>({...r,_index:idx,_seconds:Number.isFinite(r.seconds)?r.seconds:Math.round(parseFloat(r.timer||0)*3600),_datoMs: r.dato? fromLocalIsoNoTZ(r.dato).getTime():0})); const q=currentSearch.trim().toLowerCase(); const filtered=q? rows.filter(r=>{ const blob=[formatDa(r.dato), r.username||'', r.projektnr||'', r.aktivitet||'', r.sag||'', r.opgave||'', formatHMS(r._seconds)].join(' ').toLowerCase(); return blob.includes(q); }): rows; const {col,dir}=currentSort; const sgn=dir==='asc'?1:-1; filtered.sort((a,b)=>{ let va,vb; if(col==='seconds'){va=a._seconds; vb=b._seconds;} else if(col==='dato'){va=a._datoMs; vb=b._datoMs;} else {va=(a[col]||'').toString().toLowerCase(); vb=(b[col]||'').toString().toLowerCase();} if(va<vb) return -1*sgn; if(va>vb) return 1*sgn; return 0; }); return filtered; }
function totalPages(total){ return Math.max(1, Math.ceil(total/pageSize)); }
function clampPage(p,maxp){ return Math.min(Math.max(1,p),maxp); }
function gotoPage(p){ const maxp=totalPages(getDisplayRows().length); currentPage=clampPage(p,maxp); visRegistreringer(); }
function gotoPrevPage(){ gotoPage(currentPage-1); }
function gotoNextPage(){ gotoPage(currentPage+1); }
function renderPagination(total){ const maxp=totalPages(total); const pageInfo=document.getElementById('pageInfo'); const prev=document.getElementById('prevPage'); const next=document.getElementById('nextPage'); currentPage=clampPage(currentPage,maxp); pageInfo.textContent=`Side ${currentPage} af ${maxp}`; prev.disabled=currentPage<=1; next.disabled=currentPage>=maxp; }

function visRegistreringer(){ const tbody=document.getElementById('tabelBody'); tbody.innerHTML=''; const all=getDisplayRows(); const total=all.length; const start=(currentPage-1)*pageSize; const page=all.slice(start,start+pageSize); page.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`
    <td>${formatDa(r.dato)}</td>
    <td>${r.username||''}</td>
    <td>${r.projektnr||''}</td>
    <td>${r.aktivitet||''}</td>
    <td>${r.sag||''}</td>
    <td>${r.opgave||''}</td>
    <td>${formatHMS(r._seconds)}</td>
    <td></td>`; const actions=tr.lastElementChild;
    const startBtn=document.createElement('button'); startBtn.textContent='Start her'; startBtn.className='outline'; startBtn.onclick=()=>startFromRow(r._index); actions.appendChild(startBtn);
    const dupBtn=document.createElement('button'); dupBtn.textContent='Dupliker'; dupBtn.className='outline'; dupBtn.style.marginLeft='6px'; dupBtn.onclick=()=>duplicateToForm(r._index); actions.appendChild(dupBtn);
    const delBtn=document.createElement('button'); delBtn.textContent='Slet'; delBtn.className='danger'; delBtn.style.marginLeft='6px'; delBtn.onclick=()=>{ if(confirm('Slette denne registrering?')){ const allRecs=hentRegistreringer(); allRecs.splice(r._index,1); gemRegistreringer(allRecs); const newTotal=getDisplayRows().length; const maxp=totalPages(newTotal); if(currentPage>maxp) currentPage=maxp; visRegistreringer(); } }; actions.appendChild(delBtn);
    tbody.appendChild(tr);
  }); renderPagination(total);
  document.querySelectorAll('th.sortable .ind').forEach(el=>el.textContent=''); const ind=document.querySelector(`th.sortable[data-col="${currentSort.col}"] .ind`); if(ind) ind.textContent = currentSort.dir==='asc'?'▲':'▼'; }

// ===== CSV (UTF-8 BOM) =====
function eksporterCSV(){ const all=getDisplayRows(); if(all.length===0){ alert('Ingen registreringer at eksportere.'); return; } const header='DatoTid;Brugernavn;Projektnr;Aktivitetskode;Sag;Beskrivelse;Tid'; const rows=all.map(r=>{ const dt=formatDa(r.dato); const tid=formatHMS(r._seconds); const bes=(r.opgave||'').replaceAll(';',','); return `${dt};${r.username||''};${r.projektnr||''};${r.aktivitet||''};${r.sag||''};${bes};${tid}`; }); const csv=['\uFEFF'+header, ...rows].join('\n'); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tidsregistrering.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

// ===== Samples & Delete All =====
function randomChoice(a){ return a[Math.floor(Math.random()*a.length)]; }
function genSamples102(){ if(!confirm('Oprette 102 eksempelrækker? Eksisterende rækker forbliver.')) return; const users=['anna@example.com','bo@example.com','cam@firma.dk','dev@corp.io','eva@virk.dk']; const projekter=['PRJ-100','PRJ-200','PRJ-300','WEB','APP','OPS']; const aktiviteter=['DEV','QA','PM','MEET','DOC']; const sager=['SAG0001','SAG0002','SAG0003','SAG0042','SAG0123','SAG9999']; const opgaver=['Featurearbejde','Fejlretning','Kodedesign','Test','Planlægning','Møde','Dokumentation']; const now=new Date(); const list=hentRegistreringer(); for(let i=0;i<102;i++){ const d=new Date(now.getTime()-Math.floor(Math.random()*14*24*3600*1000)); d.setHours(8+Math.floor(Math.random()*9),Math.floor(Math.random()*60),Math.floor(Math.random()*60),0); const seconds=(30+Math.floor(Math.random()*270))*60; list.push({ dato:toLocalIsoNoTZ(d), username:randomChoice(users), projektnr:randomChoice(projekter), aktivitet:randomChoice(aktiviteter), sag:randomChoice(sager), opgave:randomChoice(opgaver), seconds:seconds, timer:seconds/3600, savedAt: Date.now() }); } gemRegistreringer(list); currentPage=1; visRegistreringer(); }
function deleteAll(){ if(!confirm('Slette alle rækker permanent?')) return; localStorage.removeItem('registreringer'); currentPage=1; visRegistreringer(); }

// ===== GET‑parametre =====
function applyQueryParams(){ const q=new URLSearchParams(window.location.search); if(![...q.keys()].length) return; const setIf=(id,val)=>{ if(val!=null && val!=='') document.getElementById(id).value=val; }; const dt=q.get('datetime'); if(dt){ const d=new Date(dt); if(!isNaN(d)){ document.getElementById('dato').value=toLocalIsoNoTZ(d); document.getElementById('datoVis')._flatpickr.setDate(d,true); } } setIf('username', q.get('username')); setIf('projektnr', q.get('projektnr')); setIf('aktivitet', q.get('aktivitet')); setIf('sag', q.get('sag')); setIf('opgave', q.get('opgave')); const tid=q.get('tid'); if(tid){ let seconds=null; if(tid.includes(':')){ seconds=parseHMS(tid); if(seconds==null) seconds=parseDDHHMM(tid); } else { const num=parseFloat(tid.replace(',','.')); if(!Number.isNaN(num)) seconds=Math.round(num*3600); } if(seconds!=null){ document.getElementById('timer').value=formatHMS(seconds); const act=(q.get('action')||'').toLowerCase(); if(act==='timer'){ stopTimerUI(); startTimerUIFromSeconds(seconds); } if(act==='record'){ tilføjRegistrering(); } } } else { const act=(q.get('action')||'').toLowerCase(); if(act==='timer'){ stopTimerUI(); startTimerUIFromSeconds(0); } } }

// ===== Init =====
document.addEventListener('DOMContentLoaded', ()=>{
  const now=new Date(); initDatePicker(now); setThresholdToUI(); visRegistreringer(); applyQueryParams();
  // Toggles
  document.getElementById('btnToggleSettings').addEventListener('click',()=>{ document.getElementById('settingsPanel').classList.toggle('hidden'); });
  document.getElementById('btnToggleHelp').addEventListener('click',()=>{ document.getElementById('helpPanel').classList.toggle('hidden'); });
  // Settings buttons
  document.getElementById('btnGenSamples').addEventListener('click', genSamples102);
  document.getElementById('btnDeleteAll').addEventListener('click', deleteAll);
  // søg
  document.getElementById('searchInput').addEventListener('input', e=>{ currentSearch=e.target.value||''; currentPage=1; visRegistreringer(); });
  // sort
  document.querySelectorAll('th.sortable').forEach(th=>{ th.addEventListener('click',()=>{ const col=th.getAttribute('data-col'); if(currentSort.col===col){ currentSort.dir=currentSort.dir==='asc'?'desc':'asc'; } else { currentSort.col=col; currentSort.dir='asc'; } currentPage=1; visRegistreringer(); }); });
  // threshold save
  document.getElementById('resumeThreshold').addEventListener('change',()=>{ const v=document.getElementById('resumeThreshold').value; const n=parseInt(v,10); localStorage.setItem('resumeThresholdMin',(!Number.isNaN(n)&&n>=0)? String(n):'10'); });
});

// ===== Timer knap =====
function startStopTimer(){ const btn=document.getElementById('timerBtn'); if(timerInterval){ const running=Math.floor((Date.now()-startTimeMs)/1000); accumulatedSeconds=running; clearInterval(timerInterval); timerInterval=null; btn.textContent='Start'; document.getElementById('timer').value=formatHMS(accumulatedSeconds); return; } // start
  let baseline=0; const v=(document.getElementById('timer').value||'').trim(); if(v.includes(':')){ baseline=parseHMS(v); if(baseline==null) baseline=parseDDHHMM(v)||0; } else if(v){ const num=parseFloat(v.replace(',','.')); if(!Number.isNaN(num)&&num>=0) baseline=Math.round(num*3600); }
  startTimerUIFromSeconds(baseline); }
</script>
</body>
</html>
