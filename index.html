<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tidsregistrering</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="text-center mb-4">Tidsregistrering</h1>

  <!-- Indstillinger -->
  <div class="card p-3 shadow-sm mb-3">
    <div class="row g-3 align-items-end">
      <div class="col-sm-6 col-md-4">
        <label for="resumeThreshold" class="form-label">Fortsæt hvis arkiveret inden (minutter)</label>
        <input type="number" id="resumeThreshold" class="form-control" min="0" step="1" placeholder="10">
      </div>
      <div class="col-sm-6 col-md-8">
        <small class="text-muted d-block">
          “Start her” fortsætter fra tidligere tid, hvis postens <em>dato+tid</em> er nyere end grænsen; ellers startes fra 0. Ved fortsættelse sættes dato+tid til nu, og “Tilføj” erstatter posten.
        </small>
      </div>
    </div>
  </div>

  <div class="card p-3 shadow-sm">
    <div class="row g-3">
      <div class="col-md-4">
        <label for="dato" class="form-label">Dato + tid:</label>
        <input type="datetime-local" id="dato" class="form-control" />
      </div>
      <div class="col-md-4">
        <label for="projektnr" class="form-label">Projektnummer:</label>
        <input type="text" id="projektnr" class="form-control" placeholder="Projektnummer" />
      </div>
      <div class="col-md-4">
        <label for="aktivitet" class="form-label">Aktivitetskode:</label>
        <input type="text" id="aktivitet" class="form-control" placeholder="Aktivitetskode" />
      </div>

      <div class="col-md-6">
        <label for="opgave" class="form-label">Beskrivelse:</label>
        <input type="text" id="opgave" class="form-control" placeholder="Beskriv opgaven" />
      </div>
      <div class="col-md-3">
        <label for="sag" class="form-label">Sag # (max 10)</label>
        <input type="text" id="sag" class="form-control" maxlength="10" placeholder="Sag #" />
      </div>
      <div class="col-md-3">
        <label for="timer" class="form-label">Tid (HH:MM:SS eller dec.)</label>
        <input type="text" id="timer" class="form-control" placeholder="00:00:00 eller 1,5" />
      </div>

      <div class="col-md-3 d-flex align-items-end gap-2">
        <button onclick="tilføjRegistrering()" class="btn btn-primary w-100">Tilføj</button>
        <button id="timerBtn" onclick="startStopTimer()" class="btn btn-success w-100">Start</button>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-between">
    <h4>Registreringer</h4>
    <button onclick="eksporterCSV()" class="btn btn-success btn-sm">Eksporter til CSV</button>
  </div>

  <table class="table table-striped table-bordered shadow-sm mt-2">
    <thead class="table-dark">
      <tr>
        <th>Dato + tid</th>
        <th>Projektnr</th>
        <th>Aktivitetskode</th>
        <th>Sag #</th>
        <th>Beskrivelse</th>
        <th>Tid (HH:MM:SS)</th>
        <th>Handling</th>
      </tr>
    </thead>
    <tbody id="tabelBody"></tbody>
  </table>
</div>

<script>
// ===== Utils =====
function pad2(n){ return String(n).padStart(2,'0'); }
function nowLocalDatetimeValue(){
  const d = new Date();
  d.setSeconds(0,0);
  const y = d.getFullYear();
  const m = pad2(d.getMonth()+1);
  const da = pad2(d.getDate());
  const h = pad2(d.getHours());
  const mi = pad2(d.getMinutes());
  return `${y}-${m}-${da}T${h}:${mi}`; // for <input type="datetime-local">
}
const daFmt = new Intl.DateTimeFormat('da-DK', {
  dateStyle: 'short', timeStyle: 'short', hour12: false
});
function formatDa(dateTimeLocalValue){
  // dateTimeLocalValue = "YYYY-MM-DDTHH:MM"
  const d = new Date(dateTimeLocalValue);
  if (isNaN(d)) return dateTimeLocalValue || '';
  return daFmt.format(d);
}
function formatHMS(totalSeconds) {
  const hh = pad2(Math.floor(totalSeconds / 3600));
  const mm = pad2(Math.floor((totalSeconds % 3600) / 60));
  const ss = pad2(totalSeconds % 60);
  return `${hh}:${mm}:${ss}`;
}
function parseHMStoSeconds(v) {
  const parts = v.split(':');
  if (parts.length < 2 || parts.length > 3) return null;
  const hh = parseInt(parts[0] || '0', 10);
  const mm = parseInt(parts[1] || '0', 10);
  const ss = parseInt((parts[2] || '0'), 10);
  if ([hh, mm, ss].some(n => Number.isNaN(n) || n < 0)) return null;
  return hh * 3600 + mm * 60 + ss;
}
function parseDDHHMMtoSeconds(v){
  const parts = v.split(':');
  if (parts.length !== 3) return null;
  const dd = parseInt(parts[0] || '0', 10);
  const hh = parseInt(parts[1] || '0', 10);
  const mm = parseInt(parts[2] || '0', 10);
  if ([dd, hh, mm].some(n => Number.isNaN(n) || n < 0)) return null;
  return dd*86400 + hh*3600 + mm*60;
}

// ===== LocalStorage helpers =====
function hentRegistreringer() {
  return JSON.parse(localStorage.getItem('registreringer') || '[]');
}
function gemRegistreringer(registreringer) {
  localStorage.setItem('registreringer', JSON.stringify(registreringer));
}
function getThresholdMinutes() {
  const ui = parseInt(document.getElementById('resumeThreshold').value || '', 10);
  if (!Number.isNaN(ui) && ui >= 0) return ui;
  const ls = parseInt(localStorage.getItem('resumeThresholdMin') || '', 10);
  return Number.isNaN(ls) ? 10 : ls;
}
function setThresholdToUI() {
  const saved = localStorage.getItem('resumeThresholdMin');
  document.getElementById('resumeThreshold').value = saved ?? '10';
}

// ===== Tabelvisning =====
function visRegistreringer() {
  const tabel = document.getElementById('tabelBody');
  tabel.innerHTML = '';
  const registreringer = hentRegistreringer();

  registreringer.forEach((r, index) => {
    const row = tabel.insertRow();
    row.insertCell(0).textContent = formatDa(r.dato); // dansk visning
    row.insertCell(1).textContent = r.projektnr;
    row.insertCell(2).textContent = r.aktivitet;
    row.insertCell(3).textContent = r.sag || '';
    row.insertCell(4).textContent = r.opgave;

    const seconds = Number.isFinite(r.seconds) ? r.seconds : Math.round(parseFloat(r.timer || 0) * 3600);
    row.insertCell(5).textContent = formatHMS(seconds);

    const actionCell = row.insertCell(6);

    const startBtn = document.createElement('button');
    startBtn.className = 'btn btn-sm btn-outline-success me-1';
    startBtn.textContent = 'Start her';
    startBtn.onclick = () => startFromRow(index);
    actionCell.appendChild(startBtn);

    const dupBtn = document.createElement('button');
    dupBtn.className = 'btn btn-sm btn-outline-primary me-1';
    dupBtn.textContent = 'Dupliker';
    dupBtn.onclick = () => duplicateToForm(index);
    actionCell.appendChild(dupBtn);

    const sletBtn = document.createElement('button');
    sletBtn.className = 'btn btn-sm btn-danger';
    sletBtn.textContent = 'Slet';
    sletBtn.onclick = () => {
      if (confirm('Er du sikker på, at du vil slette denne registrering?')) {
        registreringer.splice(index, 1);
        gemRegistreringer(registreringer);
        visRegistreringer();
      }
    };
    actionCell.appendChild(sletBtn);
  });
}

// ===== Timer-state =====
let timerInterval = null;
let startTimeMs = null;         // reference start (inkl. baseline)
let accumulatedSeconds = 0;     // baseline + løbende tid
let editingIndex = null;        // hvis sat: Tilføj erstatter denne post
let resumeReplace = false;      // true hvis vi fortsætter samme post

function setForm(r) {
  document.getElementById('dato').value = r.dato; // datetime-local value
  document.getElementById('projektnr').value = r.projektnr;
  document.getElementById('aktivitet').value = r.aktivitet;
  document.getElementById('opgave').value = r.opgave;
  document.getElementById('sag').value = r.sag || '';
}
function stopTimerUI() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  const btn = document.getElementById('timerBtn');
  if (btn) btn.textContent = 'Start';
}
function startTimerUIFromSeconds(seconds) {
  accumulatedSeconds = seconds;
  startTimeMs = Date.now() - seconds * 1000;
  const btn = document.getElementById('timerBtn');
  if (btn) btn.textContent = 'Stop';

  document.getElementById('timer').value = formatHMS(accumulatedSeconds);
  timerInterval = setInterval(() => {
    const totalSeconds = Math.floor((Date.now() - startTimeMs) / 1000);
    document.getElementById('timer').value = formatHMS(totalSeconds);
  }, 250);
}

function startFromRow(index) {
  const registreringer = hentRegistreringer();
  const r = registreringer[index];
  if (!r) return;

  const thresholdMin = getThresholdMinutes();
  const recordTime = r.dato ? new Date(r.dato).getTime() : Date.now();
  const withinWindow = (Date.now() - recordTime) <= thresholdMin * 60 * 1000;

  const copy = { ...r };
  if (withinWindow) {
    copy.dato = nowLocalDatetimeValue(); // dagsdato+tid ved fortsættelse
  }
  setForm(copy);

  const baseline = withinWindow
      ? (Number.isFinite(r.seconds) ? r.seconds : Math.round(parseFloat(r.timer || 0) * 3600))
      : 0;

  editingIndex = withinWindow ? index : null;
  resumeReplace = withinWindow;

  stopTimerUI();
  startTimerUIFromSeconds(baseline);
}

function duplicateToForm(index) {
  const registreringer = hentRegistreringer();
  const r = registreringer[index];
  if (!r) return;

  setForm(r);

  const seconds = Number.isFinite(r.seconds)
    ? r.seconds
    : Math.round(parseFloat(r.timer || 0) * 3600);

  document.getElementById('timer').value = formatHMS(seconds);

  stopTimerUI();
  accumulatedSeconds = 0;
  editingIndex = null;
  resumeReplace = false;
}

// Start/Stop knap (manuel)
function startStopTimer() {
  const btn = document.getElementById('timerBtn');
  if (timerInterval) {
    const now = Date.now();
    const runningSeconds = Math.floor((now - startTimeMs) / 1000);
    accumulatedSeconds = runningSeconds;
    clearInterval(timerInterval);
    timerInterval = null;
    btn.textContent = 'Start';
    document.getElementById('timer').value = formatHMS(accumulatedSeconds);
    return;
  }

  let baseline = 0;
  const v = (document.getElementById('timer').value || '').trim();
  if (v.includes(':')) {
    // støtte både HH:MM:SS og DD:HH:MM
    baseline = parseHMStoSeconds(v);
    if (baseline == null) {
      const ddhhmm = parseDDHHMMtoSeconds(v);
      baseline = ddhhmm != null ? ddhhmm : 0;
    }
  } else if (v) {
    const num = parseFloat(v.replace(',', '.'));
    if (!Number.isNaN(num) && num >= 0) baseline = Math.round(num * 3600);
  }
  startTimerUIFromSeconds(baseline);
}

// ===== Tilføj registrering =====
function tilføjRegistrering() {
  const dato = document.getElementById('dato').value; // datetime-local streng
  const projektnr = document.getElementById('projektnr').value;
  const aktivitet = document.getElementById('aktivitet').value;
  const opgave = document.getElementById('opgave').value;
  const sag = document.getElementById('sag').value;
  const field = document.getElementById('timer');
  let timerInput = field.value.trim();

  if (!dato || !projektnr || !aktivitet || !opgave || !timerInput) {
    alert('Udfyld alle felter.');
    return;
  }

  let totalSeconds;
  if (timerInterval) {
    totalSeconds = Math.floor((Date.now() - startTimeMs) / 1000);
  } else if (timerInput.includes(':')) {
    // HH:MM:SS eller DD:HH:MM
    let s = parseHMStoSeconds(timerInput);
    if (s == null) s = parseDDHHMMtoSeconds(timerInput);
    if (s == null) {
      alert('Ugyldigt tidsformat. Brug HH:MM:SS, DD:HH:MM eller decimaltal.');
      return;
    }
    totalSeconds = s;
  } else {
    const num = parseFloat(timerInput.replace(',', '.'));
    if (Number.isNaN(num)) {
      alert('Tid skal være et tal eller i formatet HH:MM:SS / DD:HH:MM');
      return;
    }
    totalSeconds = Math.round(num * 3600);
  }

  const timerHours = totalSeconds / 3600;
  const now = Date.now();

  const registreringer = hentRegistreringer();
  const record = {
    dato, projektnr, aktivitet, opgave, sag,
    seconds: totalSeconds,
    timer: timerHours,     // decimal for CSV
    savedAt: now
  };

  if (resumeReplace && editingIndex !== null && registreringer[editingIndex]) {
    registreringer[editingIndex] = record; // erstat
  } else {
    registreringer.push(record); // ny
  }

  gemRegistreringer(registreringer);
  visRegistreringer();

  // nulstil form og state
  document.getElementById('dato').value = nowLocalDatetimeValue();
  document.getElementById('projektnr').value = '';
  document.getElementById('aktivitet').value = '';
  document.getElementById('opgave').value = '';
  document.getElementById('sag').value = '';
  field.value = '';
  accumulatedSeconds = 0;
  editingIndex = null;
  resumeReplace = false;
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  const btn = document.getElementById('timerBtn');
  btn.textContent = 'Start';
}

// ===== CSV-eksport =====
function eksporterCSV() {
  const registreringer = hentRegistreringer();
  if (registreringer.length === 0) {
    alert('Der er ingen registreringer at eksportere.');
    return;
  }

  const header = 'DatoTid;Projektnr;Aktivitetskode;Sag;Beskrivelse;Timer';
  const rows = registreringer.map(r =>
    `${r.dato};${r.projektnr};${r.aktivitet};${(r.sag||'')};${r.opgave};${(r.seconds/3600).toFixed(2).replace('.', ',')}`
  );
  const csv = [header, ...rows].join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = 'tidsregistrering.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== GET-parametre (auto-udfyld/handling) =====
function applyQueryParams() {
  const q = new URLSearchParams(window.location.search);
  if (![...q.keys()].length) return;

  const setIf = (id, val) => { if (val != null && val !== '') document.getElementById(id).value = val; };

  // datetime (dato+tid)
  const dt = q.get('datetime');
  if (dt) {
    const d = new Date(dt);
    if (!isNaN(d)) {
      // til datetime-local value (lokal tid)
      const y = d.getFullYear();
      const m = pad2(d.getMonth()+1);
      const da = pad2(d.getDate());
      const h = pad2(d.getHours());
      const mi = pad2(d.getMinutes());
      setIf('dato', `${y}-${m}-${da}T${h}:${mi}`);
    }
  }

  setIf('projektnr', q.get('projektnr'));
  setIf('aktivitet', q.get('aktivitet'));
  setIf('sag', q.get('sag'));
  setIf('opgave', q.get('opgave'));

  // tid: decimal eller DD:HH:MM / HH:MM:SS
  const tid = q.get('tid');
  if (tid) {
    let seconds = null;
    if (tid.includes(':')) {
      seconds = parseHMStoSeconds(tid);
      if (seconds == null) seconds = parseDDHHMMtoSeconds(tid);
    } else {
      const num = parseFloat(tid.replace(',', '.'));
      if (!Number.isNaN(num)) seconds = Math.round(num * 3600);
    }
    if (seconds != null) {
      document.getElementById('timer').value = formatHMS(seconds);
      // Hvis action=timer ⇒ start tæller fra baseline
      if ((q.get('action') || '').toLowerCase() === 'timer') {
        stopTimerUI();
        startTimerUIFromSeconds(seconds);
      }
      // Hvis action=record ⇒ gem med det samme
      if ((q.get('action') || '').toLowerCase() === 'record') {
        tilføjRegistrering();
      }
      // draft: gør intet (felter er udfyldt)
    }
  } else {
    // ingen tid angivet, men hvis action=timer, start fra 0
    if ((q.get('action') || '').toLowerCase() === 'timer') {
      stopTimerUI();
      startTimerUIFromSeconds(0);
    }
    if ((q.get('action') || '').toLowerCase() === 'record') {
      // uden tid giver det ingen mening at gemme -> ignorer
    }
  }
}

// ===== Init ved load =====
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('dato').value = nowLocalDatetimeValue();
  setThresholdToUI();
  visRegistreringer();

  document.getElementById('resumeThreshold').addEventListener('change', () => {
    const v = document.getElementById('resumeThreshold').value;
    const n = parseInt(v, 10);
    localStorage.setItem('resumeThresholdMin', (!Number.isNaN(n) && n >= 0) ? String(n) : '10');
  });

  applyQueryParams(); // håndter GET-parametre
});
</script>
</body>
</html>
 