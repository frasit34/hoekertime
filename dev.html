<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tidsregistrering</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">


<link rel="stylesheet" href="custom.css">


</head>
<body class="bg-light">
<div class="container-fluid py-4" style="max-width: 90%; margin: auto;">
  <h1 class="text-center mb-4">Tidsregistrering</h1>

  <!-- Indstillinger + Hjælp knapper -->
  <div class="mb-3 d-flex justify-content-end gap-2">
    <button class="btn btn-outline-secondary" data-bs-toggle="collapse" data-bs-target="#settingsPanel" aria-expanded="false" title="Indstillinger">
      Indstillinger
    </button>
    <button class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#helpPanel" aria-expanded="false" title="Hjælp">
      ?
    </button>
  </div>

  <!-- Indstillinger (skjult) -->
  <div id="settingsPanel" class="collapse">
    <div class="card p-3 shadow-sm mb-3">
      <div class="row g-3 align-items-end">
        <div class="col-lg-4">
          <label for="resumeThreshold" class="form-label">Fortsæt hvis arkiveret inden (minutter)</label>
          <input type="number" id="resumeThreshold" class="form-control" min="0" step="1" placeholder="10">
          <div class="small-muted mt-1">“Start her” fortsætter fra en tidligere registrering, hvis postens dato+tid er nyere end grænsen. Ellers startes fra 0 som ny post.</div>
        </div>
        <div class="col-lg-8">
          <div class="border rounded p-2 bg-light">
            <div class="fw-semibold mb-2">Hurtig datahåndtering</div>
            <div class="d-flex flex-wrap gap-2">
              <button id="btnGenSample" class="btn btn-outline-primary">Generér 102000 eksempelrækker</button>
              <button id="btnDeleteAll" class="btn btn-outline-danger">Slet alle rækker</button>
            </div>
            <div class="small-muted mt-2">
              • <strong>Generér</strong> opretter op til 102000 demo-poster (datoer, felter og tid).<br>
              • <strong>Slet alle</strong> tømmer tabellen og lokal lagring. Begge kræver bekræftelse.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hjælp (skjult) -->
  <div id="helpPanel" class="collapse">
    <div class="card p-3 shadow-sm mb-3">
      <h5 class="mb-3">Hvordan virker siden?</h5>
      <dl class="help-list">
        <dt>Formål</dt>
        <dd>Hurtig tidsregistrering i browseren. Data gemmes i <em>LocalStorage</em> på denne enhed. Du kan starte/stoppe timer, kopiere tidligere rækker og eksportere til Excel.</dd>

        <dt>Felter</dt>
        <dd>
          <ul class="mb-2">
            <li><strong>Dato + tid</strong>: vælg i dansk format (24t med sekunder).</li>
            <li><strong>Brugernavn</strong>: e-mailadresse (valideres).</li>
            <li><strong>Projektnummer</strong> (7 cifre, starter med 19–25), <strong>Aktivitetskode</strong> (4 cifre, runde tal), <strong>Sag #</strong> (max 10), <strong>Beskrivelse</strong>.</li>
            <li><strong>Tid</strong>: HH:MM:SS, DD:HH:MM eller decimaltimer (fx 1,5).</li>
          </ul>
        </dd>

        <dt>Knapper</dt>
        <dd>
          <ul class="mb-2">
            <li><strong>Start</strong>: starter/stopper timeren (HH:MM:SS live).</li>
            <li><strong>Tilføj</strong>: gemmer posten (erstatter hvis du fortsætter en eksisterende inden for grænsen).</li>
            <li><strong>Start her</strong>: kopierer en række op i formularen og starter timeren; fortsætter/erstatter hvis inden for grænsen, ellers fra 0 som ny.</li>
            <li><strong>Dupliker</strong>: kopierer en række op (inkl. tid) uden at starte timeren; “Tilføj” laver ny række.</li>
            <li><strong>Generér 102000 eksempelrækker</strong>: lægger prøve-data i tabellen (begrænses af LocalStorage-kvote).</li>
            <li><strong>Slet alle rækker</strong>: tømmer alt (kræver bekræftelse).</li>
          </ul>
        </dd>

        <dt>GET-parametre</dt>
        <dd>
          Du kan kalde siden med parametre for at udfylde felter og evt. starte/gemme:
<pre class="mb-2"><code>?datetime=2025-08-12T09:30:00
&amp;username=bruger@example.com
&amp;projektnr=2304571
&amp;aktivitet=8400
&amp;sag=SAG000123
&amp;opgave=Fejlretning
&amp;tid=01:30:00
&amp;action=timer|record|draft</code></pre>
          <ul>
            <li><code>datetime</code>: ISO (YYYY-MM-DDTHH:MM(:SS)) – vises som <strong>DD/MM/YYYY HH:MM:SS</strong>.</li>
            <li><code>username</code>, <code>projektnr</code> (7 cifre, 19–25xxxx), <code>aktivitet</code> (4 cifre), <code>sag</code>, <code>opgave</code>, <code>tid</code>.</li>
            <li><code>action</code>:
              <ul>
                <li><code>timer</code> – udfyld felter og <em>start</em> timeren.</li>
                <li><code>record</code> – udfyld og <em>gem straks</em> (tilføjer en række).</li>
                <li><code>draft</code> – <em>kun udfyld</em> formularen, ingen timer/lagring.</li>
              </ul>
            </li>
          </ul>
          <div class="small-muted">Eksempel (timer):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=anna@firma.dk&amp;projektnr=2103478&amp;aktivitet=7200&amp;sag=SAG42&amp;opgave=Årshjul&amp;tid=01:00:00&amp;action=timer</code></div>
          <div class="small-muted mt-2">Eksempel (record):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=brian@eksempel.dk&amp;projektnr=2309876&amp;aktivitet=8400&amp;sag=SAG007&amp;opgave=Ændringsanmodning&amp;tid=2.5&amp;action=record</code></div>
          <div class="small-muted mt-2">Eksempel (draft):<br>
          <code>https://example.com/tid/?datetime=2025-08-12T09:30:00&amp;username=lotte@contoso.dk&amp;projektnr=1901200&amp;aktivitet=5600&amp;sag=SAG000777&amp;opgave=Køreplan&amp;tid=00:45:00&amp;action=draft</code></div>
        </dd>

        <dt>Eksport</dt>
        <dd>Eksport er <strong>Excel (.xlsx)</strong>. Dato/tid vises som <strong>DD/MM/YYYY HH:MM:SS</strong>, tid som <strong>HH:MM:SS</strong>. ÆØÅ bevares korrekt.</dd>
      </dl>
    </div>
  </div>

  <!-- Formular -->
  <div class="card p-3 shadow-sm">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Dato + tid:</label>
        <input type="text" id="datoVis" class="form-control" placeholder="dd/mm/yyyy hh:mm:ss" />
        <input type="hidden" id="dato" />
      </div>
      <div class="col-md-4">
        <label for="username" class="form-label">Brugernavn (e-mail):</label>
        <input type="email" id="username" class="form-control" placeholder="bruger@example.com" inputmode="email" autocomplete="username" />
      </div>
      <div class="col-md-4">
        <label for="projektnr" class="form-label">Projektnummer:</label>
        <input type="text" id="projektnr" class="form-control" placeholder="7-cifret projektnr" />
      </div>

      <div class="col-md-4">
        <label for="aktivitet" class="form-label">Aktivitetskode:</label>
        <input type="text" id="aktivitet" class="form-control" placeholder="4-cifret kode (fx 8400)" />
      </div>
      <div class="col-md-4">
        <label for="sag" class="form-label">Sag # (max 10)</label>
        <input type="text" id="sag" class="form-control" maxlength="10" placeholder="Sag #" />
      </div>
      <div class="col-md-4">
        <label for="opgave" class="form-label">Beskrivelse:</label>
        <input type="text" id="opgave" class="form-control" placeholder="Beskriv opgaven" />
      </div>

      <div class="col-md-3">
        <label for="timer" class="form-label">Tid (HH:MM:SS / DD:HH:MM / dec.)</label>
        <input type="text" id="timer" class="form-control" placeholder="00:00:00 eller 1,5" />
      </div>

      <div class="col-md-3 d-flex align-items-end gap-2">
        <button onclick="tilføjRegistrering()" class="btn btn-primary w-100">Tilføj</button>
        <button id="timerBtn" onclick="startStopTimer()" class="btn btn-success w-100">Start</button>
      </div>
    </div>
  </div>

<!-- Toolbar -->
<div class="mt-4 d-flex align-items-center justify-content-between gap-2">
  <h4 class="m-0">Registreringer</h4>

  <!-- Søg + Eksport i samme input-group, no-wrap -->
  <div class="input-group flex-nowrap" style="max-width: 560px; width: 100%;">
    <span class="input-group-text">Søg</span>
    <input id="searchInput" type="text" class="form-control" placeholder="Filtrér i tabellen...">
    <button onclick="eksporterExcel()" class="btn btn-success">Eksporter til Excel</button>
  </div>
</div>

  <!-- Tabel -->
  <div class="table-responsive">
    <table class="table table-striped table-bordered shadow-sm mt-2" id="regTable">
      <thead class="table-dark">
        <tr>
          <th class="sortable" data-col="dato">Dato + tid <span class="sort-ind"></span></th>
          <th class="sortable" data-col="username">Brugernavn <span class="sort-ind"></span></th>
          <th class="sortable" data-col="projektnr">Projektnr <span class="sort-ind"></span></th>
          <th class="sortable" data-col="aktivitet">Aktivitetskode <span class="sort-ind"></span></th>
          <th class="sortable" data-col="sag">Sag # <span class="sort-ind"></span></th>
          <th class="sortable" data-col="opgave">Beskrivelse <span class="sort-ind"></span></th>
          <th class="sortable" data-col="seconds">Tid (HH:MM:SS) <span class="sort-ind"></span></th>
          <th>Handling</th>
        </tr>
      </thead>
      <tbody id="tabelBody"></tbody>
    </table>
  </div>

  <!-- Paginering -->
  <nav class="d-flex justify-content-end" aria-label="Pagination">
    <ul class="pagination m-0">
      <li class="page-item"><button class="page-link" id="prevPage" onclick="gotoPrevPage()" type="button">Forrige</button></li>
      <li class="page-item disabled"><span class="page-link" id="pageInfo">Side 1 af 1</span></li>
      <li class="page-item"><button class="page-link" id="nextPage" onclick="gotoNextPage()" type="button">Næste</button></li>
    </ul>
  </nav>


  <!-- VERSION and footer -->
  <footer class="mt-4">
    <div class="small-muted">
      Font: Montserrat © The Montserrat Project Authors. Licens: SIL Open Font License 1.1 (OFL) • v 1.0.2
    </div>
  </footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/da.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<script>
// ===== Utils =====
function pad2(n){ return String(n).padStart(2,'0'); }
function toLocalIsoNoTZ(d){
  const y=d.getFullYear(), m=pad2(d.getMonth()+1), da=pad2(d.getDate());
  const h=pad2(d.getHours()), mi=pad2(d.getMinutes()), s=pad2(d.getSeconds());
  return `${y}-${m}-${da}T${h}:${mi}:${s}`;
}
function fromLocalIsoNoTZ(str){
  const m=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})$/.exec(str);
  if(!m) return new Date(NaN);
  const Y=+m[1], Mo=+m[2], D=+m[3], H=+m[4], Mi=+m[5], S=+m[6];
  return new Date(Y,Mo-1,D,H,Mi,S,0);
}
function formatDa_ddmmyyyy_hhmmss(localIsoStr){
  const d = fromLocalIsoNoTZ(localIsoStr);
  if (isNaN(d)) return localIsoStr || '';
  return `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()} ${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
}
function formatHMS(totalSeconds){
  const hh=pad2(Math.floor(totalSeconds/3600));
  const mm=pad2(Math.floor((totalSeconds%3600)/60));
  const ss=pad2(totalSeconds%60);
  return `${hh}:${mm}:${ss}`;
}
function parseHMStoSeconds(v){
  const p=v.split(':'); if(p.length<2||p.length>3) return null;
  const hh=parseInt(p[0]||'0',10), mm=parseInt(p[1]||'0',10), ss=parseInt((p[2]||'0'),10);
  if([hh,mm,ss].some(n=>Number.isNaN(n)||n<0)) return null;
  return hh*3600+mm*60+ss;
}
function parseDDHHMMtoSeconds(v){
  const p=v.split(':'); if(p.length!==3) return null;
  const dd=parseInt(p[0]||'0',10), hh=parseInt(p[1]||'0',10), mm=parseInt(p[2]||'0',10);
  if([dd,hh,mm].some(n=>Number.isNaN(n)||n<0)) return null;
  return dd*86400+hh*3600+mm*60;
}
function isValidEmail(v){
  if(!v) return false;
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
}

// ===== LocalStorage helpers =====
function hentRegistreringer(){ return JSON.parse(localStorage.getItem('registreringer')||'[]'); }
function gemRegistreringer(rs){ localStorage.setItem('registreringer', JSON.stringify(rs)); }
function getThresholdMinutes(){
  const ui=parseInt(document.getElementById('resumeThreshold').value||'',10);
  if(!Number.isNaN(ui)&&ui>=0) return ui;
  const ls=parseInt(localStorage.getItem('resumeThresholdMin')||'',10);
  return Number.isNaN(ls)?10:ls;
}
function setThresholdToUI(){
  const saved=localStorage.getItem('resumeThresholdMin');
  document.getElementById('resumeThreshold').value = saved ?? '10';
}

// ===== Global UI state =====
let currentSort = { col:'dato', dir:'desc' };
let currentSearch = '';
const pageSize = 50;
let currentPage = 1;

// ===== Flatpickr =====
function initDatePicker(now){
  document.getElementById('dato').value = toLocalIsoNoTZ(now);
  flatpickr("#datoVis", {
    enableTime:true, time_24hr:true, enableSeconds:true,
    dateFormat:"d/m/Y H:i:S", locale: flatpickr.l10ns.da,
    defaultDate: now,
    onChange: (dates)=>{ if(dates && dates[0]) document.getElementById('dato').value = toLocalIsoNoTZ(dates[0]); }
  });
  document.getElementById('datoVis')._flatpickr.setDate(now, true);
}

// ===== Data pipeline (filter + sort) =====
function getDisplayRows(){
  const rows = hentRegistreringer().map((r, idx)=>({
    ...r,
    _index: idx,
    _seconds: Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600),
    _datoMs: r.dato ? fromLocalIsoNoTZ(r.dato).getTime() : 0
  }));
  const q = currentSearch.trim().toLowerCase();
  const filtered = q ? rows.filter(r=>{
    const fields = [
      formatDa_ddmmyyyy_hhmmss(r.dato),
      r.username||'', r.projektnr||'', r.aktivitet||'', r.sag||'', r.opgave||'',
      formatHMS(r._seconds)
    ].join(' ').toLowerCase();
    return fields.includes(q);
  }) : rows;

  const { col, dir } = currentSort;
  const sgn = dir==='asc'?1:-1;
  filtered.sort((a,b)=>{
    let va, vb;
    if(col==='seconds'){ va=a._seconds; vb=b._seconds; }
    else if(col==='dato'){ va=a._datoMs; vb=b._datoMs; }
    else { va=(a[col]||'').toString().toLowerCase(); vb=(b[col]||'').toString().toLowerCase(); }
    if(va<vb) return -1*sgn;
    if(va>vb) return 1*sgn;
    return 0;
  });
  return filtered;
}

// ===== Pagination =====
function totalPages(total){ return Math.max(1, Math.ceil(total / pageSize)); }
function clampPage(p, maxp){ return Math.min(Math.max(1, p), maxp); }
function gotoPage(p){
  const maxp = totalPages(getDisplayRows().length);
  currentPage = clampPage(p, maxp);
  visRegistreringer();
}
function gotoPrevPage(){ gotoPage(currentPage-1); }
function gotoNextPage(){ gotoPage(currentPage+1); }
function renderPagination(totalCount){
  const maxp = totalPages(totalCount);
  const pageInfo = document.getElementById('pageInfo');
  const prev = document.getElementById('prevPage');
  const next = document.getElementById('nextPage');
  currentPage = clampPage(currentPage, maxp);
  pageInfo.textContent = `Side ${currentPage} af ${maxp}`;
  prev.disabled = currentPage <= 1;
  next.disabled = currentPage >= maxp;
}

// ===== Tabelrender =====
function visRegistreringer(){
  const tbody = document.getElementById('tabelBody');
  tbody.innerHTML = '';
  const all = getDisplayRows();
  const total = all.length;

  const start = (currentPage-1)*pageSize;
  const page = all.slice(start, start + pageSize);

  page.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${formatDa_ddmmyyyy_hhmmss(r.dato)}</td>
      <td>${r.username||''}</td>
      <td>${r.projektnr||''}</td>
      <td>${r.aktivitet||''}</td>
      <td>${r.sag||''}</td>
      <td>${r.opgave||''}</td>
      <td>${formatHMS(r._seconds)}</td>
      <td></td>
    `;
    const actions = tr.lastElementChild;

    const startBtn = document.createElement('button');
    startBtn.className='btn btn-sm btn-outline-success me-1';
    startBtn.textContent='Start her';
    startBtn.onclick = ()=> startFromRow(r._index);
    actions.appendChild(startBtn);

    const dupBtn = document.createElement('button');
    dupBtn.className='btn btn-sm btn-outline-primary me-1';
    dupBtn.textContent='Dupliker';
    dupBtn.onclick = ()=> duplicateToForm(r._index);
    actions.appendChild(dupBtn);

    const delBtn = document.createElement('button');
    delBtn.className='btn btn-sm btn-danger';
    delBtn.textContent='Slet';
    delBtn.onclick = ()=>{
      if(confirm('Er du sikker på, at du vil slette denne registrering?')){
        const allRecs = hentRegistreringer();
        allRecs.splice(r._index,1);
        gemRegistreringer(allRecs);
        const newTotal = getDisplayRows().length;
        const maxp = totalPages(newTotal);
        if(currentPage>maxp) currentPage=maxp;
        visRegistreringer();
      }
    };
    actions.appendChild(delBtn);

    tbody.appendChild(tr);
  });

  renderPagination(total);

  // FIX: korrekt callback (stopper ikke JS længere)
  document.querySelectorAll('th.sortable .sort-ind').forEach(el => el.textContent = '');
  const th = document.querySelector(`th.sortable[data-col="${currentSort.col}"] .sort-ind`);
  if(th) th.textContent = currentSort.dir==='asc'?'▲':'▼';
}

// ===== Timer-state =====
let timerInterval=null, startTimeMs=null, accumulatedSeconds=0;
let editingIndex=null, resumeReplace=false;

function setForm(r){
  document.getElementById('dato').value = r.dato;
  const d = fromLocalIsoNoTZ(r.dato);
  document.getElementById('datoVis')._flatpickr.setDate(d, true);
  document.getElementById('username').value = r.username||'';
  document.getElementById('projektnr').value = r.projektnr||'';
  document.getElementById('aktivitet').value = r.aktivitet||'';
  document.getElementById('opgave').value = r.opgave||'';
  document.getElementById('sag').value = r.sag||'';
}
function stopTimerUI(){
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  document.getElementById('timerBtn').textContent='Start';
}
function startTimerUIFromSeconds(seconds){
  accumulatedSeconds=seconds;
  startTimeMs = Date.now() - seconds*1000;
  document.getElementById('timerBtn').textContent='Stop';
  document.getElementById('timer').value = formatHMS(accumulatedSeconds);
  timerInterval = setInterval(()=>{
    const totalSeconds = Math.floor((Date.now()-startTimeMs)/1000);
    document.getElementById('timer').value = formatHMS(totalSeconds);
  }, 250);
}

function startFromRow(index){
  const all = hentRegistreringer();
  const r = all[index];
  if(!r) return;

  const thresholdMin = getThresholdMinutes();
  const recordTimeMs = r.dato ? fromLocalIsoNoTZ(r.dato).getTime() : Date.now();
  const withinWindow = (Date.now() - recordTimeMs) <= thresholdMin*60*1000;

  const copy = { ...r };
  if(withinWindow){
    const now = new Date();
    copy.dato = toLocalIsoNoTZ(now);
  }
  setForm(copy);

  const baseline = withinWindow
    ? (Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600))
    : 0;

  editingIndex = withinWindow ? index : null;
  resumeReplace = withinWindow;

  stopTimerUI();
  startTimerUIFromSeconds(baseline);
}

function duplicateToForm(index){
  const all = hentRegistreringer();
  const r = all[index];
  if(!r) return;

  setForm(r);
  const seconds = Number.isFinite(r.seconds)? r.seconds : Math.round(parseFloat(r.timer||0)*3600);
  document.getElementById('timer').value = formatHMS(seconds);

  stopTimerUI();
  accumulatedSeconds=0;
  editingIndex=null;
  resumeReplace=false;
}

function startStopTimer(){
  const btn=document.getElementById('timerBtn');
  if(timerInterval){
    const runningSeconds=Math.floor((Date.now()-startTimeMs)/1000);
    accumulatedSeconds=runningSeconds;
    clearInterval(timerInterval); timerInterval=null;
    btn.textContent='Start';
    document.getElementById('timer').value = formatHMS(accumulatedSeconds);
    return;
  }
  let baseline=0, v=(document.getElementById('timer').value||'').trim();
  if(v.includes(':')){
    baseline = parseHMStoSeconds(v);
    if(baseline==null) baseline = parseDDHHMMtoSeconds(v) ?? 0;
  } else if(v){
    const num=parseFloat(v.replace(',', '.')); if(!Number.isNaN(num)&&num>=0) baseline=Math.round(num*3600);
  }
  startTimerUIFromSeconds(baseline);
}

// ===== Tilføj registrering =====
function tilføjRegistrering(){
  const datoIso = document.getElementById('dato').value;
  const username = document.getElementById('username').value.trim();
  const projektnr = document.getElementById('projektnr').value;
  const aktivitet = document.getElementById('aktivitet').value;
  const opgave = document.getElementById('opgave').value;
  const sag = document.getElementById('sag').value;
  let t = (document.getElementById('timer').value||'').trim();

  if(!datoIso || !username || !projektnr || !aktivitet || !opgave || !t){
    alert('Udfyld alle felter (inkl. brugernavn).'); return;
  }
  if(!isValidEmail(username)){
    alert('Ugyldig e-mailadresse i Brugernavn.'); return;
  }

  let totalSeconds;
  if(timerInterval){
    totalSeconds = Math.floor((Date.now()-startTimeMs)/1000);
  } else if(t.includes(':')){
    let s=parseHMStoSeconds(t); if(s==null) s=parseDDHHMMtoSeconds(t);
    if(s==null){ alert('Ugyldigt tidsformat. Brug HH:MM:SS, DD:HH:MM eller decimaltal.'); return; }
    totalSeconds=s;
  } else {
    const num=parseFloat(t.replace(',', '.'));
    if(Number.isNaN(num)){ alert('Tid skal være et tal eller HH:MM:SS / DD:HH:MM'); return; }
    totalSeconds = Math.round(num*3600);
  }

  const now = Date.now();
  const rec = { dato:datoIso, username, projektnr, aktivitet, opgave, sag, seconds:totalSeconds, timer: totalSeconds/3600, savedAt: now };

  const all = hentRegistreringer();
  if(resumeReplace && editingIndex!=null && all[editingIndex]){
    all[editingIndex] = rec;
  } else {
    all.push(rec);
  }
  gemRegistreringer(all);

  visRegistreringer();

  // reset
  const dNow=new Date();
  document.getElementById('dato').value = toLocalIsoNoTZ(dNow);
  document.getElementById('datoVis')._flatpickr.setDate(dNow, true);
  document.getElementById('username').value='';
  document.getElementById('projektnr').value='';
  document.getElementById('aktivitet').value='';
  document.getElementById('opgave').value='';
  document.getElementById('sag').value='';
  document.getElementById('timer').value='';
  accumulatedSeconds=0; editingIndex=null; resumeReplace=false;
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  document.getElementById('timerBtn').textContent='Start';
}

// ===== Excel-eksport (.xlsx) =====
function eksporterExcel(){
  const all = getDisplayRows();
  if(all.length===0){ alert('Der er ingen registreringer at eksportere.'); return; }

  const header = ['DatoTid','Brugernavn','Projektnr','Aktivitetskode','Sag','Beskrivelse','Tid'];
  const rows = all.map(r=>[
    formatDa_ddmmyyyy_hhmmss(r.dato),
    r.username||'',
    r.projektnr||'',
    r.aktivitet||'',
    r.sag||'',
    (r.opgave||'').replaceAll(';', ','),
    formatHMS(r._seconds)
  ]);
  const aoa = [header, ...rows];
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  ws['!cols'] = [{wch:20},{wch:28},{wch:14},{wch:16},{wch:10},{wch:40},{wch:12}];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Tidsregistrering');
  XLSX.writeFile(wb, 'tidsregistrering.xlsx');
}

// ===== Sample data + slet alt =====
function randomChoice(a){ return a[Math.floor(Math.random()*a.length)]; }
function genProjektnr(){
  const prefixes = ['19','20','21','22','23','24','25'];
  const p = randomChoice(prefixes);
  const rest = String(Math.floor(Math.random()*100000)).padStart(5,'0');
  return p + rest; // 7 cifre
}
const aktivitetskoder = [1200,1400,1600,1800,2000,2400,2800,3200,3600,4000,4400,4800,5200,5600,6000,6400,7200,7600,8000,8400].map(String);
const emails = [
  'anna@firma.dk','brian@eksempel.dk','camilla@contoso.dk','dennis@firma.dk','eva@eksempel.dk',
  'frank@firma.dk','grete@contoso.dk','henrik@firma.dk','ivor@eksempel.dk','julie@firma.dk',
  'kasper@contoso.dk','lars@firma.dk','maria@eksempel.dk','niels@firma.dk','ole@contoso.dk',
  'pia@firma.dk','rasmus@eksempel.dk','sara@firma.dk','tina@contoso.dk','ulrik@firma.dk'
];
const opgaver = [
  'Fejlretning','Review','Dokumentation','Møde','Feature',
  'Årshjul','Sagsåbning','Køreplan','Kørebog','Årsafslutning',
  'Ændringsanmodning','Kvalitetssikring','Brugeroprettelse','Rådgivning',
  'Opgradering','Vedligehold','Tilpasning','Implementering','Planlægning','Udrulning'
];

const MAX_LOCALSTORAGE_ROWS = 8000;
async function generateSampleData(){
  const WANT = 102000;
  if(!confirm(`Oprette ${WANT} eksempelrækker? (LocalStorage kan ikke rumme så meget – jeg genererer op til ${MAX_LOCALSTORAGE_ROWS})`)) return;

  const base = hentRegistreringer();
  const now = new Date();
  const toMake = Math.max(0, Math.min(WANT, MAX_LOCALSTORAGE_ROWS) - base.length);
  if(toMake <= 0){
    alert('Der er allerede mindst ' + MAX_LOCALSTORAGE_ROWS + ' rækker. Slet noget først.');
    return;
  }

  const BATCH = 2000;
  for(let i=0;i<toMake;i++){
    const d = new Date(now.getTime() - Math.floor(Math.random()*30)*86400000 - Math.floor(Math.random()*8)*3600000);
    const seconds = 900 * (1 + Math.floor(Math.random()*20));
    base.push({
      dato: toLocalIsoNoTZ(d),
      username: randomChoice(emails),
      projektnr: genProjektnr(),
      aktivitet: randomChoice(aktivitetskoder),
      opgave: randomChoice(opgaver) + ' #' + (i+1),
      sag: String(10000 + i),
      seconds,
      timer: seconds/3600,
      savedAt: Date.now()
    });
    if (i % BATCH === 0 && i>0){
      gemRegistreringer(base);
      await new Promise(r=>setTimeout(r,0));
    }
  }
  gemRegistreringer(base);
  currentPage = 1;
  visRegistreringer();
  alert(`Færdig. Oprettede ${toMake} rækker (LocalStorage-loft). Hvis du vil have alle 102000, så skifter vi til IndexedDB.`);
}
function deleteAllData(){
  if(!confirm('Slette alle rækker? Dette kan ikke fortrydes.')) return;
  localStorage.removeItem('registreringer');
  currentPage = 1;
  visRegistreringer();
}

// ===== GET-parametre =====
function applyQueryParams(){
  const q=new URLSearchParams(window.location.search);
  if(![...q.keys()].length) return;
  const setIf=(id,val)=>{ if(val!=null && val!=='') document.getElementById(id).value=val; };

  const dt=q.get('datetime');
  if(dt){
    const d=new Date(dt);
    if(!isNaN(d)){
      document.getElementById('dato').value = toLocalIsoNoTZ(d);
      document.getElementById('datoVis')._flatpickr.setDate(d, true);
    }
  }
  setIf('username', q.get('username'));
  setIf('projektnr', q.get('projektnr'));
  setIf('aktivitet', q.get('aktivitet'));
  setIf('sag', q.get('sag'));
  setIf('opgave', q.get('opgave'));

  const tid=q.get('tid');
  const action=(q.get('action')||'').toLowerCase();
  if(tid){
    let seconds=null;
    if(tid.includes(':')){ seconds=parseHMStoSeconds(tid); if(seconds==null) seconds=parseDDHHMMtoSeconds(tid); }
    else { const num=parseFloat(tid.replace(',','.')); if(!Number.isNaN(num)) seconds=Math.round(num*3600); }
    if(seconds!=null){
      document.getElementById('timer').value = formatHMS(seconds);
      if(action==='timer'){ stopTimerUI(); startTimerUIFromSeconds(seconds); }
      if(action==='record'){ tilføjRegistrering(); }
    }
  } else {
    if(action==='timer'){ stopTimerUI(); startTimerUIFromSeconds(0); }
  }
}

// ===== Init =====
document.addEventListener('DOMContentLoaded', ()=>{
  const now=new Date();
  initDatePicker(now);
  setThresholdToUI();
  visRegistreringer();
  applyQueryParams();

  document.getElementById('searchInput').addEventListener('input', (e)=>{
    currentSearch = e.target.value || '';
    currentPage = 1;
    visRegistreringer();
  });

  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const col = th.getAttribute('data-col');
      if(currentSort.col===col){
        currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
      }else{
        currentSort.col=col; currentSort.dir='asc';
      }
      currentPage = 1;
      visRegistreringer();
    });
  });

  document.getElementById('resumeThreshold').addEventListener('change', ()=>{
    const v=document.getElementById('resumeThreshold').value;
    const n=parseInt(v,10);
    localStorage.setItem('resumeThresholdMin',(!Number.isNaN(n)&&n>=0)? String(n):'10');
  });

  // Settings buttons
  document.getElementById('btnGenSample').addEventListener('click', generateSampleData);
  document.getElementById('btnDeleteAll').addEventListener('click', deleteAllData);
});

// Ryd formular (ESC)
function clearForm() {
  const dNow = new Date();
  document.getElementById('dato').value = toLocalIsoNoTZ(dNow);
  document.getElementById('datoVis')._flatpickr.setDate(dNow, true);
  document.getElementById('username').value = '';
  document.getElementById('projektnr').value = '';
  document.getElementById('aktivitet').value = '';
  document.getElementById('opgave').value = '';
  document.getElementById('sag').value = '';
  document.getElementById('timer').value = '';
  accumulatedSeconds = 0;
  editingIndex = null;
  resumeReplace = false;
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  document.getElementById('timerBtn').textContent = 'Start';
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') clearForm();
});
</script>
</body>
</html>
